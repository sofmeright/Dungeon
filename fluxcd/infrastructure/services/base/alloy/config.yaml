apiVersion: v1
kind: ConfigMap
metadata:
  name: alloy-config
data:
  config.alloy: |
    // Kubernetes Service Discovery - node-scoped where possible
    discovery.kubernetes "pods" {
      role = "pod"
      selectors {
        role  = "pod"
        field = "spec.nodeName=" + env("HOSTNAME")
      }
    }

    discovery.kubernetes "nodes" {
      role = "node"
      selectors {
        role  = "node"
        field = "metadata.name=" + env("HOSTNAME")
      }
    }

    discovery.kubernetes "services" {
      role = "service"
    }

    discovery.kubernetes "endpoints" {
      role = "endpoints"
    }

    // Prometheus Remote Write - Placeholder (override in overlay)
    prometheus.remote_write "default" {
      endpoint {
        url = "PLACEHOLDER_PROMETHEUS_URL"
      }
    }

    // Relabel for pod annotation-based scraping (node-local via field selector)
    discovery.relabel "pods_metrics" {
      targets = discovery.kubernetes.pods.targets

      rule {
        source_labels = ["__meta_kubernetes_pod_annotation_prometheus_io_scrape"]
        regex         = "true"
        action        = "keep"
      }
      rule {
        source_labels = ["__meta_kubernetes_pod_annotation_prometheus_io_path"]
        regex         = "(.+)"
        target_label  = "__metrics_path__"
      }
      rule {
        source_labels = ["__address__", "__meta_kubernetes_pod_annotation_prometheus_io_port"]
        regex         = "([^:]+)(?::\\d+)?;(\\d+)"
        replacement   = "$1:$2"
        target_label  = "__address__"
      }
      rule {
        source_labels = ["__meta_kubernetes_namespace"]
        target_label  = "namespace"
      }
      rule {
        source_labels = ["__meta_kubernetes_pod_name"]
        target_label  = "pod"
      }
      rule {
        source_labels = ["__meta_kubernetes_pod_container_name"]
        target_label  = "container"
      }
      rule {
        source_labels = ["__meta_kubernetes_pod_node_name"]
        target_label  = "node"
      }
      rule {
        source_labels = ["__meta_kubernetes_pod_label_app_kubernetes_io_name"]
        target_label  = "app"
      }
    }

    prometheus.scrape "kubernetes_pods" {
      targets    = discovery.relabel.pods_metrics.output
      forward_to = [prometheus.remote_write.default.receiver]

      scrape_interval = "30s"
      scrape_timeout  = "10s"
    }

    // Service annotation-based scraping (cluster-wide, use clustering)
    discovery.relabel "services_metrics" {
      targets = discovery.kubernetes.services.targets

      rule {
        source_labels = ["__meta_kubernetes_service_annotation_prometheus_io_scrape"]
        regex         = "true"
        action        = "keep"
      }
      rule {
        source_labels = ["__meta_kubernetes_service_annotation_prometheus_io_path"]
        regex         = "(.+)"
        target_label  = "__metrics_path__"
      }
      rule {
        source_labels = ["__address__", "__meta_kubernetes_service_annotation_prometheus_io_port"]
        regex         = "([^:]+)(?::\\d+)?;(\\d+)"
        replacement   = "$1:$2"
        target_label  = "__address__"
      }
      rule {
        source_labels = ["__meta_kubernetes_namespace"]
        target_label  = "namespace"
      }
      rule {
        source_labels = ["__meta_kubernetes_service_name"]
        target_label  = "service"
      }
      rule {
        source_labels = ["__meta_kubernetes_service_label_app_kubernetes_io_name"]
        target_label  = "app"
      }
    }

    prometheus.scrape "kubernetes_services" {
      targets    = discovery.relabel.services_metrics.output
      forward_to = [prometheus.remote_write.default.receiver]

      clustering {
        enabled = true
      }

      scrape_interval = "30s"
      scrape_timeout  = "10s"
    }

    // Log Collection - filesystem-based (override in overlay with Loki URL)
    loki.write "default" {
      endpoint {
        url = "PLACEHOLDER_LOKI_URL"
      }
    }

    discovery.relabel "pods_logs" {
      targets = discovery.kubernetes.pods.targets

      rule {
        source_labels = ["__meta_kubernetes_namespace", "__meta_kubernetes_pod_name", "__meta_kubernetes_pod_uid", "__meta_kubernetes_pod_container_name"]
        separator     = "/"
        regex         = "(.+)/(.+)/(.+)/(.+)"
        replacement   = "/var/log/pods/$1_$2_$3/$4/*.log"
        target_label  = "__path__"
      }
      rule {
        source_labels = ["__meta_kubernetes_namespace"]
        target_label  = "namespace"
      }
      rule {
        source_labels = ["__meta_kubernetes_pod_name"]
        target_label  = "pod"
      }
      rule {
        source_labels = ["__meta_kubernetes_pod_container_name"]
        target_label  = "container"
      }
      // app label: prefer app.kubernetes.io/name, fall back to app label
      rule {
        source_labels = ["__meta_kubernetes_pod_label_app"]
        regex         = "(.+)"
        target_label  = "app"
      }
      rule {
        source_labels = ["__meta_kubernetes_pod_label_app_kubernetes_io_name"]
        regex         = "(.+)"
        target_label  = "app"
      }
      rule {
        source_labels = ["app"]
        target_label  = "job"
      }
      rule {
        source_labels = ["__meta_kubernetes_pod_node_name"]
        target_label  = "node"
      }
    }

    local.file_match "pod_logs" {
      path_targets = discovery.relabel.pods_logs.output
    }

    loki.source.file "pod_logs" {
      targets    = local.file_match.pod_logs.targets
      forward_to = [loki.process.parse_cri.receiver]
    }

    loki.process "parse_cri" {
      forward_to = [loki.process.add_labels.receiver]
      stage.cri {}
    }

    loki.process "add_labels" {
      forward_to = [loki.write.default.receiver]

      stage.regex {
        expression = "(?i)(?P<level>debug|info|warn|warning|error|fatal|critical)"
      }
      stage.labels {
        values = {
          level = "",
        }
      }
    }

    // Remote scrape targets - Placeholder (override in overlay)
    discovery.relabel "lighthouse_exporters" {
      targets = [
        {
          __address__ = "PLACEHOLDER_LIGHTHOUSE_IP:9100",
          job         = "node-exporter-lighthouse",
          instance    = "lighthouse",
        },
      ]
    }

    prometheus.scrape "lighthouse_exporters" {
      targets    = discovery.relabel.lighthouse_exporters.output
      forward_to = [prometheus.remote_write.default.receiver]

      clustering {
        enabled = true
      }

      scrape_interval = "30s"
      scrape_timeout  = "10s"
    }
