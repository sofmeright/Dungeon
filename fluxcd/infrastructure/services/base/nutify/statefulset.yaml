apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: nutify
spec:
  serviceName: nutify
  replicas: 1
  selector:
    matchLabels:
      app: nutify
  template:
    metadata:
      labels:
        app: nutify
    spec:
      containers:
        - name: nutify
          image: cr.pcfae.com/prplanit/nutify-ssh:latest
          ports:
            - containerPort: 3493
              name: nut
            - containerPort: 5050
              name: http
            - containerPort: 443
              name: https
          env:
            - name: LOG
              value: "true"
            - name: LOG_WERKZEUG
              value: "false"
          envFrom:
            - secretRef:
                name: nutify-secret
          command: ["/bin/bash", "/etc/nut-templates/entrypoint-wrapper.sh"]
          args: ["python3", "/app/nutify/app.py"]
          volumeMounts:
            - name: gossip-stone-nutify-logs
              mountPath: /app/nutify/logs
            - name: gossip-stone-nutify-instance
              mountPath: /app/nutify/instance
            - name: gossip-stone-nutify-ssl
              mountPath: /app/ssl
            - name: nut-config-templates
              mountPath: /etc/nut-templates
            - name: nut-config
              mountPath: /etc/nut
            - name: nutify-ssh
              mountPath: /root/.ssh
            - name: nutify-script
              mountPath: /root/script
      volumes:
        - name: nut-config-templates
          configMap:
            name: nutify-nut-config
            defaultMode: 0755
        - name: nut-config
          emptyDir: {}
        - name: nutify-script
          configMap:
            name: nutify-script
            defaultMode: 0755
        - name: nutify-ssh
          secret:
            secretName: nutify-secret
            defaultMode: 0600
            items:
              - key: NUTIFY_SSH_PRIVATE_KEY
                path: id_rsa
              - key: NUTIFY_SSH_PUBLIC_KEY
                path: id_rsa.pub
              - key: NUTIFY_SSH_KNOWN_HOSTS
                path: known_hosts
  volumeClaimTemplates:
    - metadata:
        name: gossip-stone-nutify-logs
      spec:
        accessModes:
          - ReadWriteOnce
        resources:
          requests:
            storage: 1Gi
    - metadata:
        name: gossip-stone-nutify-instance
      spec:
        accessModes:
          - ReadWriteOnce
        resources:
          requests:
            storage: 2Gi
    - metadata:
        name: gossip-stone-nutify-ssl
      spec:
        accessModes:
          - ReadWriteOnce
        resources:
          requests:
            storage: 100Mi
