apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: nutify
spec:
  serviceName: nutify
  replicas: 1
  selector:
    matchLabels:
      app: nutify
  template:
    metadata:
      labels:
        app: nutify
    spec:
      containers:
        - name: nutify
          image: cr.pcfae.com/prplanit/nutify-ssh@sha256:2566846f241b14668fa90a9fff43cddaa90c6ee0f6886447b82bd8bac3882063
          ports:
            - containerPort: 3493
              name: nut
            - containerPort: 5050
              name: http
            - containerPort: 443
              name: https
          env:
            - name: LOG
              value: "true"
            - name: LOG_WERKZEUG
              value: "false"
          envFrom:
            - secretRef:
                name: nutify-secret
          command: ["/bin/bash", "-c"]
          args:
            - |
              sed -e "s|\${NUT_SNMP_AUTH_PASSWORD}|$NUT_SNMP_AUTH_PASSWORD|g" \
                  -e "s|\${NUT_SNMP_PRIV_PASSWORD}|$NUT_SNMP_PRIV_PASSWORD|g" \
                  /etc/nut-templates/ups.conf > /etc/nut/ups.conf
              cp /etc/nut-templates/upsmon.conf /etc/nut/upsmon.conf
              cp /etc/nut-templates/nut.conf /etc/nut/nut.conf
              cp /etc/nut-templates/upsd.conf /etc/nut/upsd.conf
              cp /etc/nut-templates/upsd.users /etc/nut/upsd.users
              chmod 640 /etc/nut/*
              exec /usr/local/bin/generate-settings.sh /usr/local/bin/docker-entrypoint /usr/local/bin/start-services.sh
          volumeMounts:
            - name: gossip-stone-nutify-logs
              mountPath: /app/nutify/logs
            - name: gossip-stone-nutify-instance
              mountPath: /app/nutify/instance
            - name: gossip-stone-nutify-ssl
              mountPath: /app/ssl
            - name: nut-config-templates
              mountPath: /etc/nut-templates
            - name: nut-config
              mountPath: /etc/nut
            - name: nutify-ssh
              mountPath: /root/.ssh
            - name: nutify-script
              mountPath: /root/script
      volumes:
        - name: nut-config-templates
          configMap:
            name: nutify-nut-config
            defaultMode: 0644
        - name: nut-config
          emptyDir: {}
        - name: nutify-script
          configMap:
            name: nutify-script
            defaultMode: 0755
        - name: nutify-ssh
          secret:
            secretName: nutify-secret
            defaultMode: 0600
            items:
              - key: NUTIFY_SSH_PRIVATE_KEY
                path: id_rsa
              - key: NUTIFY_SSH_PUBLIC_KEY
                path: id_rsa.pub
              - key: NUTIFY_SSH_KNOWN_HOSTS
                path: known_hosts
  volumeClaimTemplates:
    - metadata:
        name: gossip-stone-nutify-logs
      spec:
        accessModes:
          - ReadWriteOnce
        resources:
          requests:
            storage: 1Gi
    - metadata:
        name: gossip-stone-nutify-instance
      spec:
        accessModes:
          - ReadWriteOnce
        resources:
          requests:
            storage: 2Gi
    - metadata:
        name: gossip-stone-nutify-ssl
      spec:
        accessModes:
          - ReadWriteOnce
        resources:
          requests:
            storage: 100Mi
