apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: alloy
spec:
  targetNamespace: gossip-stone
  postRenderers:
    - kustomize:
        patches:
          - target:
              kind: DaemonSet
              name: alloy
            patch: |
              apiVersion: apps/v1
              kind: DaemonSet
              metadata:
                name: alloy
              spec:
                template:
                  metadata:
                    labels:
                      policy.prplanit.com/metrics: "true"
  values:
    alloy:
      extraAnnotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "12345"
      configMap:
        create: false
        name: "alloy-config"
      clustering:
        enabled: true
      resources:
        requests:
          cpu: 100m
          memory: 256Mi
        limits:
          cpu: "3"
          memory: 2Gi
    controller:
      hostNetwork: true
      dnsPolicy: ClusterFirstWithHostNet
      tolerations:
        - key: node-role.kubernetes.io/control-plane
          operator: Exists
          effect: NoSchedule
