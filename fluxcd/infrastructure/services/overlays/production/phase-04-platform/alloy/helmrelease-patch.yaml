apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: alloy
spec:
  targetNamespace: gossip-stone
  values:
    # Run on all nodes including control plane
    tolerations:
      - key: node-role.kubernetes.io/control-plane
        operator: Exists
        effect: NoSchedule
    alloy:
      extraAnnotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "12345"
      configMap:
        create: false
        name: "alloy-config"
      resources:
        requests:
          cpu: 100m
          memory: 512Mi
        limits:
          cpu: "3"
          memory: 6Gi
  postRenderers:
    - kustomize:
        patches:
          - target:
              kind: DaemonSet
              name: alloy
            patch: |-
              apiVersion: apps/v1
              kind: DaemonSet
              metadata:
                name: alloy
              spec:
                template:
                  spec:
                    hostNetwork: true
                    dnsPolicy: ClusterFirstWithHostNet
                    tolerations:
                      - key: node-role.kubernetes.io/control-plane
                        operator: Exists
                        effect: NoSchedule
