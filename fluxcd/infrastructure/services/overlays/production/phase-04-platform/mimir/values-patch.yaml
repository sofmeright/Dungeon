apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: mimir
spec:
  values:
    # Production-specific storage class configuration - using RBD for TSDB performance
    ingester:
      persistentVolume:
        storageClass: ceph-rbd  # Fast block storage for TSDB writes
        size: 20Gi  # Provides ~85 hours (3.5 days) buffer with aggressive compaction - enough for long weekends
      # Mount S3 credentials for block uploads
      extraArgs:
        -config.expand-env: true
      extraEnvFrom:
        - secretRef:
            name: mimir-s3
      # Pod anti-affinity to spread across nodes
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 100
              podAffinityTerm:
                labelSelector:
                  matchExpressions:
                    - key: app.kubernetes.io/component
                      operator: In
                      values:
                        - ingester
                topologyKey: kubernetes.io/hostname
      # Resource limits - increased memory to prevent GC pressure during high cardinality ingestion
      resources:
        requests:
          cpu: 200m
          memory: 3Gi
        limits:
          cpu: 2
          memory: 6Gi

    store_gateway:
      persistentVolume:
        storageClass: ceph-rbd  # Fast block storage for block index cache
        size: 15Gi  # Block index cache and metadata
      # Mount S3 credentials for block queries
      extraArgs:
        -config.expand-env: true
      extraEnvFrom:
        - secretRef:
            name: mimir-s3

    compactor:
      persistentVolume:
        storageClass: ceph-rbd  # Fast block storage for compaction work
        size: 25Gi  # Compaction working directory - needs extra space for concurrent block merging
      # Mount S3 credentials for block compaction
      extraArgs:
        -config.expand-env: true
      extraEnvFrom:
        - secretRef:
            name: mimir-s3
      resources:
        requests:
          cpu: 200m
          memory: 2Gi
        limits:
          cpu: 2
          memory: 4Gi

    querier:
      # Mount S3 credentials for querying blocks from storage
      extraArgs:
        -config.expand-env: true
      extraEnvFrom:
        - secretRef:
            name: mimir-s3

    # Global imagePullSecrets for all Mimir pods
    global:
      imagePullSecrets:
        - name: jcr-pcfae-dungeon-pull-secret

    # Image configuration - use JCR pull-through cache for bandwidth efficiency
    # CRI-O requires fully qualified image names in short-name enforcement mode
    image:
      repository: docker.jcr.pcfae.com/grafana/mimir
      # tag: use chart default (inherits from chart version)

    rollout_operator:
      image:
        repository: docker.jcr.pcfae.com/grafana/rollout-operator
        # tag: use chart default

    rolloutOperator:
      image:
        repository: docker.jcr.pcfae.com/grafana/rollout-operator
        # tag: use chart default

    gateway:
      image:
        repository: docker.jcr.pcfae.com/nginxinc/nginx-unprivileged
        # tag: use chart default

    serviceMonitor:
      enabled: false  # Using Alloy service discovery instead

    # Distributor resource limits - handles metrics ingestion and routing
    distributor:
      resources:
        requests:
          cpu: 200m
          memory: 1Gi
        limits:
          cpu: 1
          memory: 2Gi  # Sufficient for normal operations with adjusted ingestion rate

    # Ingest Storage DISABLED - using classic mode with direct S3 writes
    ingest_storage:
      enabled: false

    # Kafka DISABLED - not needed for classic mode
    kafka:
      enabled: false

    mimir:
      structuredConfig:
        # Explicitly disable ingest storage in structured config
        ingest_storage:
          enabled: false

        distributor:
          remote_timeout: 10s  # Increased from default 2s to tolerate slower writes under load
          ring:
            kvstore:
              store: memberlist

        # S3 blocks storage configuration - using Ceph RGW
        common:
          storage:
            backend: s3
            s3:
              endpoint: ceph-rgw.gorons-bracelet.svc.cluster.local:80
              region: default
              bucket_name: gossip-stone-mimir
              access_key_id: ${s3_access_key}
              secret_access_key: ${s3_secret_key}
              insecure: true

        blocks_storage:
          backend: s3
          s3:
            endpoint: ceph-rgw.gorons-bracelet.svc.cluster.local:80
            region: default
            bucket_name: gossip-stone-mimir
            access_key_id: ${s3_access_key}
            secret_access_key: ${s3_secret_key}
            insecure: true
          tsdb:
            dir: /data/tsdb
            # Head compaction settings - flush to S3 more frequently to prevent disk exhaustion
            head_compaction_interval: 1h  # Compact head to blocks every hour (default: 1m but actual compaction depends on block range)
            head_compaction_idle_timeout: 1h  # Compact idle TSDB heads after 1 hour
            wal_compression_enabled: true  # Compress WAL to reduce disk usage
            wal_segment_size_bytes: 134217728  # 128MB WAL segments (default: 256MB) - smaller segments = more frequent flushing
            # Block range for compaction - use 2-hour blocks matching out-of-order window
            block_ranges_period:
              - 7200000  # 2 hours in milliseconds
            retention_period: 6h  # Only keep blocks in ingester for 6 hours before upload to S3 is mandatory
          bucket_store:
            sync_dir: /data/tsdb-sync
            # Increase sync interval to reduce load
            sync_interval: 15m  # Default: 15m
            # Block discovery and caching
            bucket_index:
              enabled: true  # Use bucket index for faster block discovery

        ingester:
          push_grpc_method_enabled: true  # Required when ingest_storage is disabled
          ring:
            kvstore:
              store: memberlist
            replication_factor: 3
            zone_awareness_enabled: false
          # Limit in-memory series to prevent OOM and encourage flushing to disk/S3
          instance_limits:
            max_series: 1500000  # Max series per ingester instance
            max_ingestion_rate: 80000  # Max samples/sec per ingester (with 3 replicas = 240k total)
          # Close idle TSDB heads faster to free up disk space
          tsdb_config_update_period: 15s  # Check for config updates every 15s

        store_gateway:
          sharding_ring:
            kvstore:
              store: memberlist
            replication_factor: 1

        compactor:
          sharding_ring:
            kvstore:
              store: memberlist
          # Compaction settings to handle corrupted blocks and reduce disk pressure
          compaction_interval: 30m  # Run compaction every 30 minutes
          data_dir: /data/compactor  # Working directory for compaction
          cleanup_interval: 15m  # Clean up old blocks every 15 minutes
          deletion_delay: 2h  # Wait 2 hours before deleting compacted blocks
          max_compaction_time: 4h  # Allow up to 4 hours for compaction jobs
          # Skip corrupted blocks instead of failing entire compaction
          block_sync_concurrency: 8  # Download up to 8 blocks concurrently
          compactor_split_and_merge_shards: 0  # Disable split-merge (use default compaction only)
          compactor_blocks_retention_period: 0  # Use default retention (unlimited in compactor)

        memberlist:
          join_members:
            - dns+mimir-gossip-ring.gossip-stone.svc.cluster.local:7946

        alertmanager:
          data_dir: /data/alertmanager

        alertmanager_storage:
          backend: filesystem
          filesystem:
            dir: /data/blocks

        limits:
          max_global_series_per_user: 0  # Unlimited series (use ingester instance_limits instead)
          # REDUCED from 200k/400k - previous rate caused 10Gi disks to fill in 18 hours
          # New rate (120k/240k total with 3 ingesters) balances performance with 50Gi disk capacity (~7 days at current load)
          ingestion_rate: 120000  # Max samples/sec per user across all distributors
          ingestion_burst_size: 240000  # Burst capacity for traffic spikes
          max_query_parallelism: 32  # Max concurrent query operations
          max_label_names_per_series: 50  # Increased from default 30 to support Docker Compose labels
          # Out-of-order window matches TSDB block range (2h) - allows recovery from power outages
          # Enables acceptance of late-arriving samples within 2-hour window
          out_of_order_time_window: 2h  # Must match blocks_storage.tsdb.block_ranges_period
