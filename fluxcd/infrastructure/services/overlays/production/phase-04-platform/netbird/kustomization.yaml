apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: zeldas-lullaby

resources:
  - ../../../../base/netbird
  - httproute.yaml

patches:
  - patch: |-
      - op: replace
        path: /spec/storage/storageClass
        value: ceph-rbd
      - op: add
        path: /spec/inheritedMetadata
        value:
          labels:
            policy.prplanit.com/cnpg: "managed"
    target:
      kind: Cluster
      name: netbird-postgres
  - patch: |-
      - op: replace
        path: /spec/template/spec/initContainers/0/image
        value: docker.io/library/busybox:1.37.0
    target:
      kind: StatefulSet
      name: netbird-management
  - patch: |-
      - op: replace
        path: /spec/template/spec/containers/0/image
        value: docker.io/netbirdio/management:0.64.4
      - op: replace
        path: /spec/template/spec/containers/0/env/3/value
        value: "86400"
    target:
      kind: StatefulSet
      name: netbird-management
  - patch: |-
      - op: replace
        path: /spec/template/spec/containers/0/image
        value: docker.io/netbirdio/signal:0.64.4
    target:
      kind: StatefulSet
      name: netbird-signal
  - patch: |-
      - op: replace
        path: /spec/template/spec/containers/0/image
        value: docker.io/netbirdio/dashboard:v2.30.1
    target:
      kind: Deployment
      name: netbird-dashboard
  - patch: |-
      - op: replace
        path: /spec/template/spec/containers/0/image
        value: docker.io/netbirdio/relay:0.64.4
    target:
      kind: Deployment
      name: netbird-relay
  - patch: |-
      - op: replace
        path: /spec/template/spec/initContainers/0/image
        value: docker.io/library/busybox:1.37.0
      - op: replace
        path: /spec/template/spec/initContainers/0/env/2/value
        value: "71.24.190.221"
      - op: replace
        path: /spec/template/spec/containers/0/image
        value: docker.io/coturn/coturn:4.8.0
    target:
      kind: Deployment
      name: netbird-coturn
  - patch: |-
      - op: replace
        path: /spec/secretStoreRef/name
        value: vault-zeldas-letter
      - op: replace
        path: /spec/data/0/remoteRef/key
        value: apps/netbird
      - op: replace
        path: /spec/data/1/remoteRef/key
        value: apps/netbird
      - op: replace
        path: /spec/data/2/remoteRef/key
        value: apps/netbird
      - op: replace
        path: /spec/data/3/remoteRef/key
        value: apps/netbird
      - op: replace
        path: /spec/data/4/remoteRef/key
        value: apps/netbird
      - op: replace
        path: /spec/data/5/remoteRef/key
        value: apps/netbird
      - op: replace
        path: /spec/data/6/remoteRef/key
        value: apps/netbird
      - op: replace
        path: /spec/data/7/remoteRef/key
        value: apps/netbird
      - op: replace
        path: /spec/data/8/remoteRef/key
        value: apps/netbird
      - op: replace
        path: /spec/data/9/remoteRef/key
        value: apps/netbird
      - op: replace
        path: /spec/data/10/remoteRef/key
        value: apps/netbird
      - op: replace
        path: /spec/data/11/remoteRef/key
        value: apps/netbird
      - op: replace
        path: /spec/data/12/remoteRef/key
        value: apps/netbird
    target:
      kind: ExternalSecret
      name: netbird-secrets
  - patch: |-
      - op: add
        path: /metadata/annotations
        value:
          lbipam.cilium.io/ips: "172.22.30.86"
          lbipam.cilium.io/sharing-key: "zeldas-lullaby"
          lbipam.cilium.io/sharing-cross-namespace: "*"
          gatus.home-operations.com/endpoint: |
            group: "Administration (Zelda's LullabyðŸŽµ)"
            url: tcp://172.22.30.86:3478
            interval: 60s
            conditions:
              - "[CONNECTED] == true"
    target:
      kind: Service
      name: netbird-coturn
  - patch: |-
      - op: replace
        path: /spec/volumeClaimTemplates/0/spec/storageClassName
        value: ceph-rbd
    target:
      kind: StatefulSet
      name: netbird-management
  - patch: |-
      - op: replace
        path: /spec/volumeClaimTemplates/0/spec/storageClassName
        value: ceph-rbd
    target:
      kind: StatefulSet
      name: netbird-signal
