apiVersion: postgresql.cnpg.io/v1
kind: Cluster
metadata:
  name: grafana-postgres
  namespace: gossip-stone
spec:
  instances: 3

  affinity:
    podAntiAffinityType: required

  # Fast failover optimizations
  switchoverDelay: 30  # Reduced from default 3600s for faster planned switchovers

  # Optimize failure detection and recovery
  startDelay: 10       # Reduced from default 3600s
  stopDelay: 10        # Reduced from default 1800s
  livenessProbeTimeout: 5

  postgresql:
    # Enable synchronous replication for zero data loss and fast failover
    synchronous:
      method: any      # Any 1 replica can acknowledge
      number: 1        # At least 1 replica must confirm writes

    parameters:
      shared_buffers: "128MB"
      max_connections: "50"
      # Faster detection of primary failure
      wal_receiver_timeout: "5s"
      # WAL retention limits - prevent disk from filling
      wal_keep_size: "128MB"  # Reduced from 512MB default
      max_slot_wal_keep_size: "400MB"  # 8% of 5Gi PVC

  # Enable monitoring
  monitoring:
    enablePodMonitor: true

  bootstrap:
    initdb:
      database: grafana
      owner: grafana

  enableSuperuserAccess: true

  storage:
    storageClass: ceph-rbd
    size: 5Gi
