apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: grafana
spec:
  values:
    # Prometheus scraping
    podAnnotations:
      prometheus.io/scrape: "true"
      prometheus.io/port: "3000"

    # HA configuration
    replicas: 3

    # Disable built-in persistence - using PostgreSQL instead
    persistence:
      enabled: false

    # Configure PostgreSQL database
    grafana.ini:
      server:
        root_url: "https://grafana.pcfae.com"
        serve_from_sub_path: false
      database:
        type: postgres
        host: grafana-postgres-rw.gossip-stone.svc.cluster.local:5432
        name: grafana
        ssl_mode: disable

    # Map secret keys to Grafana environment variables
    envValueFrom:
      GF_DATABASE_USER:
        secretKeyRef:
          name: grafana-postgres-credentials
          key: username
      GF_DATABASE_PASSWORD:
        secretKeyRef:
          name: grafana-postgres-credentials
          key: password

    # Override default plugins volume with RWX PVC
    # sidecar is used to override the default emptyDir plugins volume
    sidecar:
      plugins:
        enabled: false  # Disable sidecar plugin loader to avoid conflicts

    # Add RWX volume for shared plugins
    extraVolumes:
      - name: grafana-plugins-shared
        existingClaim: gossip-stone-grafana-plugins

    extraVolumeMounts:
      - name: grafana-plugins-shared
        mountPath: /var/lib/grafana/plugins

    service:
      annotations:
        lbipam.cilium.io/ips: "172.22.30.137"
        lbipam.cilium.io/sharing-key: "gossip-stone"
        lbipam.cilium.io/sharing-cross-namespace: "*"
