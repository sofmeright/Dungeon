apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: grafana
spec:
  values:
    # Prometheus scraping
    podAnnotations:
      prometheus.io/scrape: "true"
      prometheus.io/port: "3000"

    # HA configuration
    replicas: 3

    # Disable built-in persistence - using PostgreSQL instead
    persistence:
      enabled: false

    # Configure PostgreSQL database
    grafana.ini:
      server:
        root_url: "https://grafana.pcfae.com"
        serve_from_sub_path: false
      database:
        type: postgres
        host: grafana-postgres-rw.gossip-stone.svc.cluster.local:5432
        name: grafana
        ssl_mode: disable

    # Map secret keys to Grafana environment variables
    envValueFrom:
      GF_DATABASE_USER:
        secretKeyRef:
          name: grafana-postgres-credentials
          key: username
      GF_DATABASE_PASSWORD:
        secretKeyRef:
          name: grafana-postgres-credentials
          key: password

    # Datasource provisioning
    datasources:
      datasources.yaml:
        apiVersion: 1
        datasources:
          - name: VictoriaMetrics
            type: prometheus
            access: proxy
            url: http://vmselect.gossip-stone.svc.cluster.local:8481/select/0/prometheus
            isDefault: true
            editable: false
            jsonData:
              timeInterval: 30s
              httpMethod: POST
          - name: Loki
            type: loki
            access: proxy
            url: http://loki-gateway.gossip-stone.svc.cluster.local:80
            editable: false
            jsonData:
              maxLines: 1000

    # Dashboard provisioning
    dashboardProviders:
      dashboardproviders.yaml:
        apiVersion: 1
        providers:
          - name: 'default'
            orgId: 1
            folder: ''
            type: file
            disableDeletion: false
            editable: true
            options:
              path: /var/lib/grafana/dashboards/default

    # Mount dashboards from ConfigMap
    dashboardsConfigMaps:
      default: grafana-dashboards

    # Override default plugins volume with RWX PVC
    # sidecar is used to override the default emptyDir plugins volume
    sidecar:
      plugins:
        enabled: false  # Disable sidecar plugin loader to avoid conflicts
      dashboards:
        enabled: false  # Using provisioning instead

    # Add RWX volume for shared plugins
    extraVolumes:
      - name: grafana-plugins-shared
        existingClaim: gossip-stone-grafana-plugins

    extraVolumeMounts:
      - name: grafana-plugins-shared
        mountPath: /var/lib/grafana/plugins

    service:
      annotations:
        lbipam.cilium.io/ips: "172.22.30.137"
        lbipam.cilium.io/sharing-key: "gossip-stone"
        lbipam.cilium.io/sharing-cross-namespace: "*"
