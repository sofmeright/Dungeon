apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: gitlab
spec:
  targetNamespace: hyrule-castle
  upgrade:
    disableWait: true
  chart:
    spec:
      sourceRef:
        namespace: hyrule-castle
  values:
    global:
      hosts:
        domain: prplanit.com
        gitlab:
          name: git.prplanit.com
        ssh: git.prplanit.com

      shell:
        port: 2424  # SSH port for git operations
        service:
          type: LoadBalancer
          annotations:
            lbipam.cilium.io/ips: "172.22.30.71"
            lbipam.cilium.io/sharing-key: "hyrule-castle"

      # S3/RGW object storage configuration
      appConfig:
        initialDefaults:
          signupEnabled: false  # Disable public signups

        # SMTP Configuration
        smtp:
          enabled: true
          address: smtp.gmail.com
          port: 587
          user_name: precisionplanit@gmail.com
          password:
            secret: gitlab-smtp-oidc
            key: smtp_password
          domain: smtp.gmail.com
          authentication: login
          starttls_auto: true
          tls: false
          openssl_verify_mode: peer

        # Email settings
        email_from: precisionplanit@gmail.com
        email_display_name: GitLab
        email_reply_to: precisionplanit@gmail.com
        email_subject_suffix: ""

        # OmniAuth / OIDC Configuration
        omniauth:
          enabled: true
          allowSingleSignOn: ['openid_connect']
          blockAutoCreatedUsers: false
          autoLinkUser: ['openid_connect']
          providers:
            - secret: gitlab-smtp-oidc
              key: provider

        lfs:
          enabled: true
          proxy_download: true
          bucket: gitlab-lfs
          connection:
            secret: gitlab-s3-storage
            key: connection
        artifacts:
          enabled: true
          proxy_download: true
          bucket: gitlab-artifacts
          connection:
            secret: gitlab-s3-storage
            key: connection
        uploads:
          enabled: true
          proxy_download: true
          bucket: gitlab-uploads
          connection:
            secret: gitlab-s3-storage
            key: connection
        packages:
          enabled: true
          proxy_download: true
          bucket: gitlab-packages
          connection:
            secret: gitlab-s3-storage
            key: connection
        backups:
          bucket: gitlab-backups
          tmpBucket: gitlab-tmp

      registry:
        bucket: gitlab-registry

      minio:
        enabled: false  # Using external Ceph RGW

      # NGINX configuration (affects webservice nginx)
      nginx:
        clientMaxBodySize: "2048m"
        proxyReadTimeout: 3600
        proxyConnectTimeout: 300
        proxySendTimeout: 300
        customHeaders:
          Content-Security-Policy: ""
          X-Frame-Options: ""

      # External PostgreSQL (CloudNativePG)
      psql:
        host: gitlab-postgresql-rw.hyrule-castle.svc.cluster.local
        port: 5432
        database: gitlabhq_production
        username: gitlab
        password:
          secret: gitlab-postgresql-credentials
          key: password


      # External Redis with Sentinel (official redis:7.4-alpine cluster)
      redis:
        host: gitlab-redis  # Master name monitored by Sentinel
        port: 6379
        sentinels:
          - host: gitlab-sentinel-0.gitlab-sentinel-headless.hyrule-castle.svc.cluster.local
            port: 26379
          - host: gitlab-sentinel-1.gitlab-sentinel-headless.hyrule-castle.svc.cluster.local
            port: 26379
          - host: gitlab-sentinel-2.gitlab-sentinel-headless.hyrule-castle.svc.cluster.local
            port: 26379
        auth:
          enabled: true
          secret: gitlab-redis-password
          key: password

      # Praefect PostgreSQL configuration
      praefect:
        psql:
          host: gitlab-postgresql-rw.hyrule-castle.svc.cluster.local
          port: 5432
          database: praefect
          username: praefect
          password:
            secret: gitlab-praefect-credentials
            key: password

    # Use Ceph RBD for all persistent volumes
    gitaly:
      persistence:
        storageClass: ceph-rbd-retain

    # External PostgreSQL (CloudNativePG)
    postgresql:
      install: false  # Disable built-in PostgreSQL

    # Workhorse - increased upload limits
    gitlab-workhorse:
      workhorse:
        maxUploadSize: 2048m

    # NGINX - increased limits and custom headers
    nginx-ingress:
      enabled: false

    # High Availability: Scale critical components to 3 replicas for 2-node failure tolerance
    gitlab:
      webservice:
        minReplicas: 3
        maxReplicas: 5
        # Trust proxies to extract real client IP for CSRF protection
        trustedProxies:
          - "10.144.0.0/12"  # Service CIDR
          - "192.168.144.0/20"  # Pod CIDR
      sidekiq:
        minReplicas: 3
        maxReplicas: 5
      kas:
        minReplicas: 3
        maxReplicas: 5
      gitlab-shell:
        minReplicas: 3
        maxReplicas: 5

    # Container Registry HA
    registry:
      hpa:
        minReplicas: 3
        maxReplicas: 5

    # Praefect HA (Gitaly cluster coordinator)
    praefect:
      replicas: 3

    # GitLab Shell SSH configuration
    gitlab-shell:
      service:
        type: LoadBalancer
        annotations:
          lbipam.cilium.io/ips: "172.22.30.71"
          lbipam.cilium.io/sharing-key: "hyrule-castle"
