apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: harbor
spec:
  targetNamespace: hyrule-castle
  install:
    timeout: 15m
  valuesFrom:
    - kind: Secret
      name: harbor-secrets
      valuesKey: postgres_password
      targetPath: database.external.password
    - kind: Secret
      name: harbor-secrets
      valuesKey: s3_accesskey
      targetPath: persistence.imageChartStorage.s3.accesskey
    - kind: Secret
      name: harbor-secrets
      valuesKey: s3_secretkey
      targetPath: persistence.imageChartStorage.s3.secretkey
  values:
    # External URL
    externalURL: https://172.22.30.71:9483

    # Harbor components - 3 replicas for HA with fully qualified images
    portal:
      replicas: 3
      image:
        repository: docker.io/goharbor/harbor-portal

    core:
      replicas: 3
      image:
        repository: docker.io/goharbor/harbor-core

    jobservice:
      replicas: 3
      image:
        repository: docker.io/goharbor/harbor-jobservice

    registry:
      replicas: 3
      registry:
        image:
          repository: docker.io/goharbor/registry-photon
      controller:
        image:
          repository: docker.io/goharbor/harbor-registryctl

    # Expose settings for TLS with nodePort
    expose:
      type: nodePort
      tls:
        enabled: true
        certSource: auto
        auto:
          commonName: "172.22.30.71"

    nginx:
      podLabels:
        policy.prplanit.com/ingress: "true"
      image:
        repository: docker.io/goharbor/nginx-photon

    # External PostgreSQL via CloudNativePG
    database:
      type: external
      external:
        host: harbor-postgres-rw
        port: 5432
        username: harbor
        password: ""  # Injected by valuesFrom
        coreDatabase: registry
        notaryServerDatabase: notaryserver
        notarySignerDatabase: notarysigner

    # External Redis (our 3-replica StatefulSet)
    redis:
      type: external
      external:
        addr: harbor-redis-0.harbor-redis.hyrule-castle.svc.cluster.local:6379

    # Storage configuration - Ceph RGW (S3 compatible)
    persistence:
      enabled: true
      persistentVolumeClaim:
        registry:
          storageClass: ceph-rbd-retain
          size: 50Gi
        jobservice:
          jobLog:
            # Use CephFS (RWX) for multi-replica jobservice
            existingClaim: hyrule-castle-harbor-jobservice
            storageClass: ""
            size: ""
      imageChartStorage:
        type: s3
        s3:
          region: us-east-1
          bucket: harbor
          accesskey: ""  # Injected by valuesFrom
          secretkey: ""  # Injected by valuesFrom
          regionendpoint: http://ceph-rgw.gorons-bracelet.svc.cluster.local
          secure: false

    # Admin password from existing secret
    existingSecretAdminPassword: harbor-secrets
    existingSecretAdminPasswordKey: admin_password

    # Disable Trivy and Notary for now
    trivy:
      enabled: false

    notary:
      enabled: false
