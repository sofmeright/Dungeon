apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: cilium
spec:
  values:
    k8sServiceHost: "172.22.144.105"

    # Enable IPv6 for external connectivity
    ipv6:
      enabled: true

    operator:
      replicas: 1
      resources:
        requests:
          cpu: 50m
          memory: 256Mi
        limits:
          cpu: 500m
          memory: 512Mi
    # eBPF native datapath configuration
    bpf:
      # Disable BPF masquerade for Istio Ambient compatibility
      # (falls back to iptables masquerade - Istio rewrites health probe source IPs
      # to 169.254.7.127 which BPF masquerade breaks before Istio can process them)
      # See: https://github.com/cilium/cilium/issues/36022
      masquerade: false
      # Enable additional BPF features for better performance
      lbExternalClusterIP: true

    # Use DSR mode for load balancers (preserves source IPs)
    loadBalancer:
      mode: dsr
      acceleration: native
      algorithm: maglev
      serviceTopology: true
      # DSR dispatch mode - 'geneve' for better compatibility
      dsrDispatch: geneve

    # NodePort configuration for eBPF
    nodePort:
      enabled: true
      mode: dsr

    # Enable auto-direct routes between nodes (eBPF native)
    autoDirectNodeRoutes: true

    # Enable masquerading ONLY for traffic going outside the cluster
    enableIPv4Masquerade: true

    # Cluster-specific network configuration
    # Native routing (no masquerade) for pod network - this is the key!
    # Traffic within this CIDR uses eBPF native routing without any NAT
    ipv4NativeRoutingCIDR: "192.168.144.0/20"
    ipv6NativeRoutingCIDR: "fc00:f1:d759:3053:a573::/64"

    # Also configure routing mode explicitly
    routingMode: native

    # Enable geneve tunnel protocol (required for geneve DSR dispatch)
    tunnelProtocol: "geneve"

    # L2 announcements disabled - using BGP instead
    l2announcements:
      enabled: false

    # Additional performance optimizations
    bpfClockProbe: true

    # Istio Ambient mode compatibility - limit socket LB to host namespace
    # Prevents Cilium from interfering with Istio's traffic redirection
    # See: https://docs.cilium.io/en/stable/network/servicemesh/istio/
    socketLB:
      hostNamespaceOnly: true

    # CNI configuration for Istio Ambient mode compatibility
    cni:
      exclusive: false

    # Enable endpoint routes for better performance
    endpointRoutes:
      enabled: true

    # Enable host routing - REQUIRED for LoadBalancer with native routing
    hostRouting: true

    # Hubble UI service configuration
    hubble:
      ui:
        service:
          type: LoadBalancer
          annotations:
            lbipam.cilium.io/ips: "172.22.30.137"
            lbipam.cilium.io/sharing-key: "gossip-stone"
            lbipam.cilium.io/sharing-cross-namespace: "*"
