apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: velero
  namespace: flux-system
spec:
  targetNamespace: fairy-bottle
  values:
    # Note: Chart already sets prometheus.io/scrape and prometheus.io/port annotations by default
    image:
      pullSecrets:
        - jcr-pcfae-dungeon-pull-secret
    initContainers:
      - name: velero-plugin-for-aws
        image: docker.io/velero/velero-plugin-for-aws:v1.13.0
        imagePullPolicy: IfNotPresent
        volumeMounts:
          - mountPath: /target
            name: plugins
    configuration:
      # Enable CSI snapshots feature
      features: EnableCSI

      backupStorageLocation:
        - name: default
          provider: aws
          bucket: velero-backups
          config:
            region: us-east-1
            s3ForcePathStyle: "true"
            s3Url: http://172.22.150.101:9002
            insecureSkipTLSVerify: "true"

      volumeSnapshotLocation:
        - name: default
          provider: csi

    credentials:
      existingSecret: velero-minio-credentials

    nodeAgent:
      podVolumePath: /var/lib/kubelet/pods
      privileged: false
      resources:
        requests:
          memory: 200Mi
          cpu: 100m
        limits:
          memory: 1Gi
          cpu: 500m

    resources:
      requests:
        memory: 128Mi
        cpu: 100m
      limits:
        memory: 512Mi
        cpu: 500m

    schedules:
      daily-backup:
        disabled: false
        schedule: "0 2 * * *"
        template:
          ttl: "720h0m0s"
          # CRITICAL: Enable file-level backups to MinIO instead of relying on CSI snapshots
          # This ensures backups are independent of the Ceph storage backend
          defaultVolumesToFsBackup: true
          includedNamespaces:
            # Administrative services (vault, weave, zitadel)
            - zeldas-lullaby
            # Archival/Content Management & Media Servers
            - temple-of-time
            # Discovery & Dashboards
            - lost-woods
            # Monitoring services
            - gossip-stone
            # IDS/IPS/SIEM security monitoring
            - lens-of-truth
            # Game servers
            - shooting-gallery
            # Gateway for internal-only services
            - arylls-lookout
            # Gateway for personal/public services
            - kokiri-forest
            # Gateway for business/work services (GitLab!)
            - hyrule-castle
            # Routing & Gateway infrastructure
            - king-of-red-lions
            # RDP/remote control services
            - hookshot
            # Arr apps & downloaders
            - swift-sail
            # Restricted/privileged services
            - pedestal-of-time
            # Mail services
            - delivery-bag
            # Bot protection & security services
            - wallmaster
            # Tools w/o userdata
            - tingle-tuner
            # Storage services
            - gorons-bracelet
            # DNS & NTP services
            - compass
          excludedResources:
            - events
            - events.events.k8s.io
            - persistentvolumes/plex-media-movies
            - persistentvolumes/plex-media-tv
            - persistentvolumes/plex-media-music
            - persistentvolumes/plex-media-photos
            - persistentvolumes/jellyfin-media-movies
            - persistentvolumes/jellyfin-media-tv
            - persistentvolumes/jellyfin-media-music
            - persistentvolumes/jellyfin-media-photos
            - persistentvolumes/photoprism-import
            - persistentvolumes/photoprism-originals
            - persistentvolumes/calibre-web-books
            - persistentvolumeclaims/plex-media-movies
            - persistentvolumeclaims/plex-media-tv
            - persistentvolumeclaims/plex-media-music
            - persistentvolumeclaims/plex-media-photos
            - persistentvolumeclaims/jellyfin-media-movies
            - persistentvolumeclaims/jellyfin-media-tv
            - persistentvolumeclaims/jellyfin-media-music
            - persistentvolumeclaims/jellyfin-media-photos
            - persistentvolumeclaims/photoprism-import
            - persistentvolumeclaims/photoprism-originals
            - persistentvolumeclaims/calibre-web-books-pvc
            # Plex transcoding cache
            - persistentvolumeclaims/transcode-plex-0
            - persistentvolumeclaims/temple-of-time-plex-transcode-plex-0
            # Jellyfin metadata cache
            - persistentvolumeclaims/temple-of-time-jellyfin-cache-jellyfin-0
            # APT cacher logs and cache
            - persistentvolumeclaims/hyrule-castle-apt-cacher-ng-logs-apt-cacher-ng-0
            - persistentvolumeclaims/hyrule-castle-apt-cacher-ng-cache-apt-cacher-ng-0
            # InvoiceNinja application cache
            - persistentvolumeclaims/hyrule-castle-invoiceninja-app-cache-invoiceninja-app-0
            # Gluetun VPN temporary files
            - persistentvolumeclaims/swift-sail-gluetun-primary-gluetun-tmp-gluetun-primary-0
            - persistentvolumeclaims/swift-sail-gluetun-primary-gluetun-tmp-qbittorrent-0
            - persistentvolumeclaims/swift-sail-qbittorrent-gluetun-tmp-qbittorrent-0
            # Arr apps media libraries (50Ti+ each - too large to backup)
            - persistentvolumeclaims/radarr-movies
            - persistentvolumeclaims/sonarr-tv-shows
            - persistentvolumeclaims/lidarr-music
            - persistentvolumeclaims/readarr-books
            - persistentvolumeclaims/bazarr-movies
            - persistentvolumeclaims/bazarr-tv-shows
            - persistentvolumeclaims/pinchflat-downloads
            - persistentvolumeclaims/pyload-ng-downloads
            # Downloader working directories
            - persistentvolumeclaims/swift-sail-qbittorrent-downloads-qbittorrent-0
            - persistentvolumeclaims/swift-sail-gluetun-primary-downloads-gluetun-primary-0
            - persistentvolumeclaims/swift-sail-gluetun-primary-downloads-qbittorrent-0
            - persistentvolumeclaims/downloads-radarr-0
            - persistentvolumeclaims/downloads-sonarr-0
            # Immich photo library
            - persistentvolumeclaims/library-immich-0
            - persistentvolumeclaims/temple-of-time-immich-library-immich-0
            # Plex MS-X media and transcode (pedestal-of-time)
            - persistentvolumeclaims/plex-ms-x-media-movies
            - persistentvolumeclaims/plex-ms-x-media-photos
            - persistentvolumeclaims/kai-plex-ms-x-transcode
            # AI/ML output and models
            - persistentvolumeclaims/output-stable-diffusion-webui-0
            # Frigate NVR storage
            - persistentvolumeclaims/storage-frigate-0
            # ARK server binaries and game files (NOT save data)
            - persistentvolumeclaims/ark-sa-serverfiles-pvc
            - persistentvolumeclaims/shooting-gallery-ark-se-tmc-theisland-serverfiles-ark-se-tmc-theisland-0
            # CephFS infrastructure mounts (handled by external backup)
            - persistentvolumeclaims/cephfs-root-temp-pvc
            - persistentvolumeclaims/gorons-bracelet-cephfs-root
            - persistentvolumeclaims/gossip-stone-grafana-plugins
          storageLocation: default
          volumeSnapshotLocations:
            - default
