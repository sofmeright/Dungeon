apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: crowdsec-cloudflare-bouncer
spec:
  replicas: 1
  template:
    metadata:
      annotations:
        ipam.cilium.io/ip-address: "192.168.153.200"
    spec:
      initContainers:
      - name: config-substitution
        image: docker.jcr.pcfae.com/alpine:latest
        command:
        - sh
        - -c
        - |
          apk add --no-cache gettext
          envsubst < /config-template/crowdsec-cloudflare-bouncer.yaml > /config/crowdsec-cloudflare-bouncer.yaml
        env:
        - name: CROWDSEC_LAPI_KEY
          valueFrom:
            secretKeyRef:
              name: crowdsec-secrets
              key: CROWDSEC_LAPI_KEY
        - name: CLOUDFLARE_TOKEN
          valueFrom:
            secretKeyRef:
              name: crowdsec-secrets
              key: CLOUDFLARE_TOKEN
        volumeMounts:
        - name: bouncer-config-template
          mountPath: /config-template
        - name: bouncer-config-rendered
          mountPath: /config
      containers:
      - name: cloudflare-bouncer
        image: ghcr.jcr.pcfae.com/crowdsecurity/cloudflare-bouncer:latest
        volumeMounts:
        - name: bouncer-config-rendered
          mountPath: /etc/crowdsec/bouncers
        resources:
          requests:
            cpu: "100m"
            memory: "128Mi"
          limits:
            cpu: "250m"
            memory: "256Mi"
      volumes:
      - name: bouncer-config-template
        configMap:
          name: crowdsec-cloudflare-bouncer
      - name: bouncer-config-rendered
        emptyDir: {}
