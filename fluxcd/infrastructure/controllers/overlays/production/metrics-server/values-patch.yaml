apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: metrics-server
spec:
  values:
    # Production-specific image configuration
    image:
      repository: registry.k8s.io/metrics-server/metrics-server
      # tag: use chart default

    # Arguments for kubelet certificate verification
    args:
      - --cert-dir=/tmp
      - --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname
      - --kubelet-use-node-status-port
      - --metric-resolution=15s

    # Resource limits for production
    resources:
      requests:
        cpu: 100m
        memory: 200Mi
      limits:
        cpu: 500m
        memory: 500Mi

    # High availability with multiple replicas
    replicas: 2

    # Pod anti-affinity to spread across nodes
    affinity:
      podAntiAffinity:
        preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            podAffinityTerm:
              labelSelector:
                matchLabels:
                  app.kubernetes.io/name: metrics-server
              topologyKey: kubernetes.io/hostname
