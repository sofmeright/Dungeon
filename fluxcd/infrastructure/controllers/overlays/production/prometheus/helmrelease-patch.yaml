apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: prometheus
spec:
  targetNamespace: gossip-stone
  values:
    prometheus:
      prometheusSpec:
        storageSpec:
          volumeClaimTemplate:
            spec:
              storageClassName: ceph-rbd-retain
              resources:
                requests:
                  storage: 10Gi

        # Enable Thanos sidecar
        thanos:
          image: quay.io/thanos/thanos:v0.36.1
          version: v0.36.1
          objectStorageConfig:
            secret:
              type: S3
              config:
                bucket: prometheus
                endpoint: ceph-rgw.gorons-bracelet.svc.cluster.local:80
                insecure: true
                access_key: ${S3_ACCESS_KEY}
                secret_key: ${S3_SECRET_KEY}

      # Enable Thanos service for querying
      thanosService:
        enabled: true
        port: 10901

  valuesFrom:
    - kind: Secret
      name: prometheus-s3
      valuesKey: s3_access_key
      targetPath: prometheus.prometheusSpec.thanos.objectStorageConfig.secret.config.access_key
    - kind: Secret
      name: prometheus-s3
      valuesKey: s3_secret_key
      targetPath: prometheus.prometheusSpec.thanos.objectStorageConfig.secret.config.secret_key
