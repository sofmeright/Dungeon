apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: prometheus
spec:
  targetNamespace: gossip-stone
  values:
    prometheus:
      prometheusSpec:
        # Enable HA with 3 replicas
        replicas: 3
        storageSpec:
          volumeClaimTemplate:
            spec:
              storageClassName: ceph-rbd-retain
              resources:
                requests:
                  storage: 10Gi

        # Resource limits - increased for WAL replay
        resources:
          requests:
            memory: 1Gi
            cpu: 500m
          limits:
            memory: 4Gi
            cpu: "2"

        # Disable Prometheus compaction for Thanos compatibility
        disableCompaction: true

        # Mount the Thanos objstore config secret
        volumes:
          - name: thanos-objstore-config
            secret:
              secretName: thanos-objstore

        # Enable Thanos sidecar
        thanos:
          image: quay.io/thanos/thanos:v0.36.1
          volumeMounts:
            - name: thanos-objstore-config
              mountPath: /etc/thanos/objstore
              readOnly: true
          # Reference the config file
          additionalArgs:
            - name: objstore.config-file
              value: /etc/thanos/objstore/objstore.yml

      # Enable Thanos service for querying
      thanosService:
        enabled: true
        port: 10901
