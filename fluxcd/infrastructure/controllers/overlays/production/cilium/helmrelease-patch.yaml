apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: cilium
  namespace: flux-system
spec:
  values:
    # Enable BPF masquerade for internet traffic only
    bpf:
      masquerade: true  # Enable masquerade for non-cluster traffic
      # Enable additional BPF features for better performance
      lbExternalClusterIP: true

    # Use DSR mode for load balancers (preserves source IPs)
    loadBalancer:
      mode: dsr
      acceleration: native

    # Enable auto-direct routes between nodes
    autoDirectNodeRoutes: true

    # Enable IPv4 masquerading for external traffic
    enableIPv4Masquerade: true

    # Configure masquerading to exclude cluster and local traffic
    ipv4NativeRoutingCIDR: "192.168.144.0/20"  # Pod CIDR - no masquerade
    ipMasqAgent:
      enabled: true
      config:
        nonMasqueradeCIDRs:
          - 192.168.144.0/20  # Pod CIDR
          - 10.144.0.0/12     # Service CIDR
          - 172.22.0.0/16     # Node network

    # Additional performance optimizations
    bpfClockProbe: true
    bpfLBSockHostnsOnly: false

    # Enable endpoint routes for better performance
    endpointRoutes:
      enabled: true