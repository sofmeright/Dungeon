apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: cilium
  namespace: flux-system
spec:
  values:
    # eBPF native datapath configuration
    bpf:
      masquerade: true  # Enable BPF masquerade for external traffic
      # Enable additional BPF features for better performance
      lbExternalClusterIP: true

    # Use DSR mode for load balancers (preserves source IPs)
    loadBalancer:
      mode: dsr
      acceleration: native

    # NodePort configuration for eBPF
    nodePort:
      enabled: true
      mode: dsr

    # Enable auto-direct routes between nodes (eBPF native)
    autoDirectNodeRoutes: true

    # Enable masquerading ONLY for traffic going outside the cluster
    enableIPv4Masquerade: true

    # Native routing (no masquerade) for pod network - this is the key!
    # Traffic within this CIDR uses eBPF native routing without any NAT
    ipv4NativeRoutingCIDR: "192.168.144.0/20"

    # Also configure routing mode explicitly
    routingMode: native

    # Disable tunnel (we're using native routing)
    tunnelProtocol: ""

    # Enable L2 announcements for LoadBalancer IPs
    l2announcements:
      enabled: true

    # Additional performance optimizations
    bpfClockProbe: true
    bpfLBSockHostnsOnly: false

    # Enable endpoint routes for better performance
    endpointRoutes:
      enabled: true