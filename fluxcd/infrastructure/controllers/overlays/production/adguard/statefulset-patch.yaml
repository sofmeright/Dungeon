apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: adguard
spec:
  replicas: 2
  template:
    spec:
      imagePullSecrets:
      - name: jcr-pcfae-dungeon-pull-secret
      initContainers:
      - name: copy-config
        image: docker.jcr.pcfae.com/busybox:1.36
        command:
        - sh
        - -c
        - |
          if [ ! -f /opt/adguardhome/conf/AdGuardHome.yaml ]; then
            echo "Copying and updating initial config..."
            cp /tmp/config/AdGuardHome.yaml /tmp/processed-config.yaml
            sed -i "s|ADGUARD_PASSWORD_PLACEHOLDER|${ADGUARD_PASSWORD}|g" /tmp/processed-config.yaml
            cp /tmp/processed-config.yaml /opt/adguardhome/conf/AdGuardHome.yaml
          else
            echo "Config already exists, skipping..."
          fi
        env:
        - name: ADGUARD_PASSWORD
          valueFrom:
            secretKeyRef:
              name: adguard-secret
              key: admin-password
        volumeMounts:
        - name: config-template
          mountPath: /tmp/config
        - name: adguard-conf
          mountPath: /opt/adguardhome/conf
      containers:
      - name: adguard
        image: docker.jcr.pcfae.com/adguard/adguardhome:v0.107.66
  volumeClaimTemplates:
  - metadata:
      name: adguard-data
    spec:
      accessModes:
        - ReadWriteOnce
      storageClassName: ceph-rbd
      resources:
        requests:
          storage: 5Gi
  - metadata:
      name: adguard-conf
    spec:
      accessModes:
        - ReadWriteOnce
      storageClassName: ceph-rbd
      resources:
        requests:
          storage: 1Gi