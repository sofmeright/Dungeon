apiVersion: batch/v1
kind: Job
metadata:
  name: ceph-rgw-init
spec:
  template:
    spec:
      containers:
      - name: init
        image: quay.io/ceph/ceph:v18
        command:
        - /bin/bash
        - -c
        - |
          set -ex

          # Wait for RGW to be ready
          until radosgw-admin realm list 2>/dev/null; do
            echo "Waiting for RGW to be accessible..."
            sleep 5
          done

          # Create realm if it doesn't exist
          if ! radosgw-admin realm get --rgw-realm=dungeon 2>/dev/null; then
            radosgw-admin realm create --rgw-realm=dungeon --default
          fi

          # Create zonegroup if it doesn't exist
          if ! radosgw-admin zonegroup get --rgw-zonegroup=default 2>/dev/null; then
            radosgw-admin zonegroup create --rgw-zonegroup=default --endpoints=http://ceph-rgw.gorons-bracelet.svc.cluster.local --master --default
          fi

          # Create zone if it doesn't exist
          if ! radosgw-admin zone get --rgw-zone=default 2>/dev/null; then
            radosgw-admin zone create --rgw-zonegroup=default --rgw-zone=default --endpoints=http://ceph-rgw.gorons-bracelet.svc.cluster.local --master --default
          fi

          # Commit period
          radosgw-admin period update --commit

          echo "RGW initialization complete"
