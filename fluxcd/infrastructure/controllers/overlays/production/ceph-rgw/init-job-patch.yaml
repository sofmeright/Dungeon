apiVersion: batch/v1
kind: Job
metadata:
  name: ceph-rgw-init
spec:
  template:
    spec:
      containers:
      - name: init
        image: quay.io/ceph/ceph:v18
        command:
        - /bin/bash
        - -c
        - |
          set -e

          echo "=== RGW Initialization Starting ==="

          # Create realm if it doesn't exist
          if ! radosgw-admin realm get --rgw-realm=dungeon 2>/dev/null; then
            echo "Creating realm dungeon..."
            radosgw-admin realm create --rgw-realm=dungeon --default
          else
            echo "Realm dungeon already exists"
          fi

          # Get or create zonegroup
          if ! radosgw-admin zonegroup get --rgw-zonegroup=default 2>/dev/null; then
            echo "Creating zonegroup default..."
            radosgw-admin zonegroup create --rgw-zonegroup=default --rgw-realm=dungeon --master --default
          else
            echo "Zonegroup default already exists"
          fi

          # Apply zonegroup config from ConfigMap
          echo "Applying zonegroup configuration..."
          ZONEGROUP_ID=$(radosgw-admin zonegroup get --rgw-zonegroup=default 2>/dev/null | grep '"id"' | head -1 | cut -d'"' -f4)
          cat /config/zonegroup.json | sed "s/\"id\": \"[^\"]*\"/\"id\": \"$ZONEGROUP_ID\"/" | \
            sed "s/\"realm_id\": \"[^\"]*\"/\"realm_id\": \"$(radosgw-admin realm get --rgw-realm=dungeon | grep '"id"' | head -1 | cut -d'"' -f4)\"/" > /tmp/zonegroup.json
          radosgw-admin zonegroup set --rgw-zonegroup=default --infile=/tmp/zonegroup.json

          # Get or create zone
          if ! radosgw-admin zone get --rgw-zone=default 2>/dev/null; then
            echo "Creating zone default..."
            radosgw-admin zone create --rgw-zonegroup=default --rgw-zone=default --master --default --endpoints=http://ceph-rgw.gorons-bracelet.svc.cluster.local
          else
            echo "Zone default already exists"
          fi

          # Apply zone config from ConfigMap
          echo "Applying zone configuration with custom pool names..."
          ZONE_ID=$(radosgw-admin zone get --rgw-zone=default 2>/dev/null | grep '"id"' | head -1 | cut -d'"' -f4)
          REALM_ID=$(radosgw-admin realm get --rgw-realm=dungeon | grep '"id"' | head -1 | cut -d'"' -f4)
          cat /config/zone.json | \
            sed "s/\"id\": \"[^\"]*\"/\"id\": \"$ZONE_ID\"/" | \
            sed "s/\"realm_id\": \"[^\"]*\"/\"realm_id\": \"$REALM_ID\"/" > /tmp/zone.json
          radosgw-admin zone set --rgw-zone=default --infile=/tmp/zone.json

          # Update zonegroup to reference the zone
          echo "Updating zonegroup with zone reference..."
          radosgw-admin zonegroup get --rgw-zonegroup=default > /tmp/zonegroup-current.json
          cat /tmp/zonegroup-current.json | \
            sed "s/\"master_zone\": \"[^\"]*\"/\"master_zone\": \"$ZONE_ID\"/" | \
            sed "s/\"zones\": \[\]/\"zones\": [{\"id\": \"$ZONE_ID\", \"name\": \"default\", \"endpoints\": [\"http:\/\/ceph-rgw.gorons-bracelet.svc.cluster.local\"]}]/" > /tmp/zonegroup-updated.json
          radosgw-admin zonegroup set --rgw-zonegroup=default --infile=/tmp/zonegroup-updated.json

          # Commit period
          echo "Committing period..."
          radosgw-admin period update --commit

          echo "=== RGW Initialization Complete ==="
          echo "Configured pools:"
          echo "  - dungeon-rgw.* (metadata)"
          echo "  - dungeon-rgw-data (object data)"
        volumeMounts:
        - name: ceph-config
          mountPath: /etc/ceph/ceph.conf
          subPath: ceph.conf
          readOnly: true
        - name: ceph-keyring
          mountPath: /etc/ceph/ceph.keyring
          subPath: keyring
          readOnly: true
        - name: zone-config
          mountPath: /config
          readOnly: true
      volumes:
      - name: ceph-config
        configMap:
          name: ceph-config
      - name: ceph-keyring
        secret:
          secretName: ceph-rgw-keyring
      - name: zone-config
        configMap:
          name: ceph-rgw-zone-config
