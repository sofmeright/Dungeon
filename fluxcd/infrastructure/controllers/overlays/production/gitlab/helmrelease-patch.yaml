apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: gitlab
spec:
  targetNamespace: hyrule-castle
  upgrade:
    disableWait: true
  chart:
    spec:
      sourceRef:
        namespace: hyrule-castle
  values:
    global:
      hosts:
        domain: prplanit.com
        gitlab:
          name: gitlab.prplanit.com
        ssh: gitlab.prplanit.com

      shell:
        port: 2424  # SSH port for git operations
        service:
          type: LoadBalancer
          annotations:
            lbipam.cilium.io/ips: "172.22.30.71"
            lbipam.cilium.io/sharing-key: "hyrule-castle"

      # S3/RGW object storage configuration
      appConfig:
        initialDefaults:
          signupEnabled: false  # Disable public signups
        lfs:
          enabled: true
          proxy_download: true
          bucket: gitlab-lfs
          connection:
            secret: gitlab-s3-storage
            key: connection
        artifacts:
          enabled: true
          proxy_download: true
          bucket: gitlab-artifacts
          connection:
            secret: gitlab-s3-storage
            key: connection
        uploads:
          enabled: true
          proxy_download: true
          bucket: gitlab-uploads
          connection:
            secret: gitlab-s3-storage
            key: connection
        packages:
          enabled: true
          proxy_download: true
          bucket: gitlab-packages
          connection:
            secret: gitlab-s3-storage
            key: connection
        backups:
          bucket: gitlab-backups
          tmpBucket: gitlab-tmp

      registry:
        bucket: gitlab-registry

      minio:
        enabled: false  # Using external Ceph RGW

      # External PostgreSQL (CloudNativePG)
      psql:
        host: gitlab-postgresql-rw.hyrule-castle.svc.cluster.local
        port: 5432
        database: gitlabhq_production
        username: gitlab
        password:
          secret: gitlab-postgresql-credentials
          key: password


      # External Redis with Sentinel (official redis:7.4-alpine)
      redis:
        host: gitlab-redis.hyrule-castle.svc.cluster.local
        port: 6379
        sentinels:
        - host: gitlab-redis-0.gitlab-redis-headless.hyrule-castle.svc.cluster.local
          port: 26379
        - host: gitlab-redis-1.gitlab-redis-headless.hyrule-castle.svc.cluster.local
          port: 26379
        - host: gitlab-redis-2.gitlab-redis-headless.hyrule-castle.svc.cluster.local
          port: 26379
        auth:
          enabled: true
          secret: gitlab-redis-password
          key: password

      # Praefect PostgreSQL configuration
      praefect:
        psql:
          host: gitlab-postgresql-rw.hyrule-castle.svc.cluster.local
          port: 5432
          database: praefect
          username: praefect
          password:
            secret: gitlab-praefect-credentials
            key: password

    # Use Ceph RBD for all persistent volumes
    gitaly:
      persistence:
        storageClass: ceph-rbd-retain

    # External PostgreSQL (CloudNativePG)
    postgresql:
      install: false  # Disable built-in PostgreSQL

    # GitLab Shell SSH configuration
    gitlab-shell:
      service:
        type: LoadBalancer
        annotations:
          lbipam.cilium.io/ips: "172.22.30.71"
          lbipam.cilium.io/sharing-key: "hyrule-castle"
