---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: zitadel
spec:
  template:
    spec:
      initContainers:
      - name: wait-for-setup
        image: docker.io/alpine/k8s:1.34.0
        command:
        - sh
        - -c
        - |
          echo "Waiting for setup job to complete and create admin service account secret..."
          until kubectl get secret zitadel-k8s-admin-sa -n zeldas-lullaby 2>/dev/null; do
            echo "Secret zitadel-k8s-admin-sa not found yet, waiting..."
            sleep 5
          done
          echo "Setup complete! Secret zitadel-k8s-admin-sa exists."
      containers:
      - name: zitadel
        image: ghcr.io/zitadel/zitadel:v4.6.1
---
apiVersion: batch/v1
kind: Job
metadata:
  name: zitadel-init
spec:
  template:
    spec:
      initContainers:
      - name: wait-for-postgres
        image: docker.io/postgres:16-alpine
        command:
        - sh
        - -c
        - |
          until pg_isready -h zitadel-postgres-rw.zeldas-lullaby.svc.cluster.local -p 5432 -U postgres; do
            echo "waiting for postgres"
            sleep 2
          done
      containers:
      - name: zitadel-init
        image: ghcr.io/zitadel/zitadel:v4.6.1
---
apiVersion: batch/v1
kind: Job
metadata:
  name: zitadel-setup
spec:
  template:
    spec:
      initContainers:
      - name: wait-for-db
        image: docker.io/alpine/k8s:1.34.0
      containers:
      - name: zitadel-setup
        image: ghcr.io/zitadel/zitadel:v4.6.1
      - name: pat-extractor
        image: docker.io/alpine/k8s:1.34.0
---
apiVersion: batch/v1
kind: Job
metadata:
  name: zitadel-admin-sa-init
spec:
  template:
    spec:
      containers:
      - name: extract-admin-sa
        image: docker.io/alpine:3.21
---
apiVersion: batch/v1
kind: Job
metadata:
  name: zitadel-admin-sa-to-vault
spec:
  template:
    spec:
      initContainers:
      - name: wait-for-secret
        image: registry.k8s.io/kubectl:v1.34.0
      containers:
      - name: sync-to-vault
        image: docker.jcr.pcfae.com/curlimages/curl:8.16.0
---
apiVersion: batch/v1
kind: Job
metadata:
  name: zitadel-login-v2-provision
spec:
  template:
    spec:
      initContainers:
      - name: wait-for-zitadel
        image: docker.jcr.pcfae.com/curlimages/curl:8.16.0
      containers:
      - name: provision-login-client
        image: docker.jcr.pcfae.com/curlimages/curl:8.16.0