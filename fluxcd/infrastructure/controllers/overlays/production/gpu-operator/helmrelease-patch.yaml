apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: gpu-operator
spec:
  values:
    # Node selector - only deploy GPU components to nodes with GPUs
    # Initially target dungeon-chest-004, can be expanded later
    daemonsets:
      nodeSelector:
        kubernetes.io/hostname: dungeon-chest-004
      tolerations:
        - key: nvidia.com/gpu
          operator: Exists
          effect: NoSchedule

    # Driver configuration for production
    driver:
      enabled: true
      # Let the operator install drivers in containers
      usePreinstalledDrivers: false
      # Driver 580 series for Ubuntu 24.04 kernel 6.8.0-85-generic
      # Supports both GTX 980 Ti and A2000 GPUs
      version: "580-6.8.0-85-generic"

      # Node selector for driver daemonset
      nodeSelector:
        kubernetes.io/hostname: dungeon-chest-004

    # Toolkit node selector
    toolkit:
      nodeSelector:
        kubernetes.io/hostname: dungeon-chest-004
      env:
        - name: CDI_ENABLED
          value: "true"
        - name: NVIDIA_CONTAINER_RUNTIME_MODE
          value: "cdi"

    # Device plugin node selector
    devicePlugin:
      nodeSelector:
        kubernetes.io/hostname: dungeon-chest-004

    # DCGM exporter node selector
    dcgmExporter:
      nodeSelector:
        kubernetes.io/hostname: dungeon-chest-004

    # GPU Feature Discovery node selector
    gfd:
      nodeSelector:
        kubernetes.io/hostname: dungeon-chest-004

    # Validator - disabled in production (CDI mode doesn't require validation)
    validator:
      enabled: false
