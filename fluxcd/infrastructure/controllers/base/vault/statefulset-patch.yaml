apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: vault
  namespace: vault
spec:
  template:
    spec:
      containers:
      - name: vault
        image: docker.io/hashicorp/vault:1.15.2
        # existing vault container config...
      - name: vault-unseal
        image: docker.io/hashicorp/vault:1.15.2
        command: ["/bin/sh"]
        args: ["/scripts/unseal.sh"]
        env:
        - name: VAULT_ADDR
          value: "http://127.0.0.1:8200"
        - name: VAULT_UNSEAL_0
          valueFrom:
            secretKeyRef:
              name: vault-unseal-keys
              key: vault-unseal-0
        - name: VAULT_UNSEAL_1
          valueFrom:
            secretKeyRef:
              name: vault-unseal-keys
              key: vault-unseal-1
        - name: VAULT_UNSEAL_2
          valueFrom:
            secretKeyRef:
              name: vault-unseal-keys
              key: vault-unseal-2
        volumeMounts:
        - name: unseal-script
          mountPath: /scripts
        resources:
          requests:
            memory: "64Mi"
            cpu: "10m"
          limits:
            memory: "128Mi"
            cpu: "100m"
      volumes:
      - name: unseal-script
        configMap:
          name: vault-unseal-script
          defaultMode: 0755