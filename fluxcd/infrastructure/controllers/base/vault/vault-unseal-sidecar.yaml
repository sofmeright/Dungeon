apiVersion: v1
kind: ConfigMap
metadata:
  name: vault-unseal-script
  namespace: vault
data:
  unseal.sh: |
    #!/bin/sh
    set -e

    echo "Starting Vault auto-unseal sidecar..."

    while true; do
      # Check if Vault is sealed
      SEALED=$(vault status -format=json 2>/dev/null | jq -r '.sealed' || echo "true")

      if [ "$SEALED" = "true" ]; then
        echo "Vault is sealed, attempting to unseal..."

        # Try each unseal key
        vault operator unseal "$VAULT_UNSEAL_0" || true
        sleep 1
        vault operator unseal "$VAULT_UNSEAL_1" || true
        sleep 1
        vault operator unseal "$VAULT_UNSEAL_2" || true

        # Check if unsealed now
        SEALED=$(vault status -format=json 2>/dev/null | jq -r '.sealed' || echo "true")
        if [ "$SEALED" = "false" ]; then
          echo "Vault successfully unsealed!"
        else
          echo "Failed to unseal Vault, will retry..."
        fi
      else
        echo "Vault is already unsealed"
      fi

      # Check every 30 seconds
      sleep 30
    done