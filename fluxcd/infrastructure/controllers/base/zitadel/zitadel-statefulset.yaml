apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: zitadel
spec:
  replicas: PLACEHOLDER_REPLICAS
  serviceName: zitadel
  selector:
    matchLabels:
      app: zitadel
  template:
    metadata:
      labels:
        app: zitadel
    spec:
      serviceAccountName: zitadel
      containers:
      - name: zitadel
        image: PLACEHOLDER_IMAGE
        ports:
        - containerPort: 8080
          name: http
        env:
        - name: ZITADEL_MASTERKEY
          valueFrom:
            secretKeyRef:
              name: zitadel-masterkey
              key: masterkey
        - name: ZITADEL_DATABASE_POSTGRES_USER_PASSWORD
          valueFrom:
            secretKeyRef:
              name: zitadel-secrets
              key: ZITADEL_DATABASE_POSTGRES_USER_PASSWORD
        - name: ZITADEL_DATABASE_POSTGRES_ADMIN_PASSWORD
          valueFrom:
            secretKeyRef:
              name: zitadel-postgres-superuser
              key: password
        - name: ZITADEL_DEFAULTINSTANCE_SMTPCONFIGURATION_SMTP_USER
          valueFrom:
            secretKeyRef:
              name: zitadel-secrets
              key: SMTP_USER
        - name: ZITADEL_DEFAULTINSTANCE_SMTPCONFIGURATION_SMTP_PASSWORD
          valueFrom:
            secretKeyRef:
              name: zitadel-secrets
              key: SMTP_PASSWORD
        # First instance configuration (machine user)
        - name: ZITADEL_FIRSTINSTANCE_INSTANCENAME
          value: "PLACEHOLDER_INSTANCE_NAME"
        - name: ZITADEL_FIRSTINSTANCE_DEFAULTLANGUAGE
          value: "PLACEHOLDER_DEFAULT_LANGUAGE"
        - name: ZITADEL_FIRSTINSTANCE_ORG_NAME
          value: "PLACEHOLDER_ORG_NAME"
        - name: ZITADEL_FIRSTINSTANCE_ORG_MACHINE_MACHINE_USERNAME
          value: "PLACEHOLDER_MACHINE_USERNAME"
        - name: ZITADEL_FIRSTINSTANCE_ORG_MACHINE_MACHINE_NAME
          value: "PLACEHOLDER_MACHINE_NAME"
        - name: ZITADEL_FIRSTINSTANCE_ORG_MACHINE_PAT_EXPIRATIONDATE
          value: "PLACEHOLDER_PAT_EXPIRATION"
        - name: ZITADEL_FIRSTINSTANCE_PATPATH
          value: "/machine-creds/pat"
        - name: ZITADEL_FIRSTINSTANCE_MACHINEKEYPATH
          value: "/machine-creds/machinekey"
        # Kubernetes integration
        - name: KUBERNETES_SERVICE_HOST
          value: "kubernetes.default.svc"
        - name: KUBERNETES_SERVICE_PORT
          value: "443"
        - name: ZITADEL_PORT
          value: "8080"
        - name: ZITADEL_EXTERNALPORT
          value: "443"
        - name: POD_IP
          valueFrom:
            fieldRef:
              fieldPath: status.podIP
        command:
        - /app/zitadel
        - start-from-init
        - --config
        - /config/zitadel-config.yaml
        - --masterkeyFromEnv
        - --tlsMode
        - external
        volumeMounts:
        - name: zitadel-config
          mountPath: /config
          readOnly: true
        - name: machine-creds
          mountPath: /machine-creds
        resources:
          requests:
            memory: "512Mi"
            cpu: "250m"
          limits:
            memory: "1Gi"
            cpu: "1000m"
        livenessProbe:
          httpGet:
            path: /debug/healthz
            port: 8080
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /debug/ready
            port: 8080
          initialDelaySeconds: 10
          periodSeconds: 5
      volumes:
      - name: zitadel-config
        configMap:
          name: zitadel-config
      - name: machine-creds
        emptyDir: {}