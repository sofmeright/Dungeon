apiVersion: batch/v1
kind: Job
metadata:
  name: zitadel-admin-sa-init
spec:
  ttlSecondsAfterFinished: 86400
  backoffLimit: 5
  template:
    spec:
      restartPolicy: OnFailure
      serviceAccountName: zitadel
      containers:
      - name: extract-admin-sa
        image: PLACEHOLDER_ALPINE_IMAGE
        command:
        - sh
        - -c
        - |
          set -e
          echo "Installing kubectl..."
          apk add --no-cache curl
          curl -LO "https://dl.k8s.io/release/v1.34.0/bin/linux/amd64/kubectl"
          chmod +x kubectl
          mv kubectl /usr/local/bin/

          echo "Checking if secret already exists..."
          if kubectl get secret zitadel-k8s-admin-sa 2>/dev/null; then
            echo "Secret zitadel-k8s-admin-sa already exists, skipping"
            exit 0
          fi

          echo "Waiting for setup job to complete..."
          until kubectl get job zitadel-setup -o jsonpath='{.status.succeeded}' 2>/dev/null | grep -q "1"; do
            echo "Waiting for zitadel-setup job to complete..."
            sleep 10
          done

          echo "Setup job completed! Finding setup pod..."
          SETUP_POD=$(kubectl get pods -l job-name=zitadel-setup -o jsonpath='{.items[0].metadata.name}')

          if [ -z "$SETUP_POD" ]; then
            echo "ERROR: Could not find setup job pod"
            exit 1
          fi

          echo "Found setup pod: $SETUP_POD"
          echo "Checking for PAT file in setup pod..."

          # Try to read PAT file from setup job pod
          if kubectl exec $SETUP_POD -- cat /machine-creds/pat 2>/dev/null; then
            echo "PAT file found! Reading credentials..."
            PAT=$(kubectl exec $SETUP_POD -- cat /machine-creds/pat)

            if [ -n "$PAT" ]; then
              echo "Creating Kubernetes secret zitadel-k8s-admin-sa..."
              kubectl create secret generic zitadel-k8s-admin-sa \
                --from-literal=token="$PAT" \
                --dry-run=client -o yaml | kubectl apply -f -

              echo "Secret created successfully!"
              exit 0
            else
              echo "ERROR: PAT file is empty"
              exit 1
            fi
          else
            echo "WARNING: PAT file not found in setup pod"
            echo "Machine user may not have been created during setup"
            echo "Check if FIRSTINSTANCE env vars are properly configured"
            exit 1
          fi
