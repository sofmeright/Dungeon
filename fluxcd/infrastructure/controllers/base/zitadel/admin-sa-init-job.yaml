apiVersion: batch/v1
kind: Job
metadata:
  name: zitadel-admin-sa-init
spec:
  ttlSecondsAfterFinished: 86400
  backoffLimit: 5
  template:
    spec:
      restartPolicy: OnFailure
      serviceAccountName: zitadel
      containers:
      - name: extract-admin-sa
        image: PLACEHOLDER_ALPINE_IMAGE
        command:
        - sh
        - -c
        - |
          set -e
          echo "Installing kubectl..."
          apk add --no-cache curl
          curl -LO "https://dl.k8s.io/release/v1.34.0/bin/linux/amd64/kubectl"
          chmod +x kubectl
          mv kubectl /usr/local/bin/

          echo "Checking if secret already exists..."
          if kubectl get secret zitadel-k8s-admin-sa 2>/dev/null; then
            echo "Secret zitadel-k8s-admin-sa already exists, skipping"
            exit 0
          fi

          echo "Waiting for Zitadel pod to be ready..."
          until kubectl get pod zitadel-0 -o jsonpath='{.status.phase}' 2>/dev/null | grep -q "Running"; do
            echo "Waiting for zitadel-0 pod to be running..."
            sleep 10
          done

          echo "Zitadel pod is running! Waiting for it to be ready..."
          until kubectl get pod zitadel-0 -o jsonpath='{.status.containerStatuses[0].ready}' 2>/dev/null | grep -q "true"; do
            echo "Waiting for zitadel-0 container to be ready..."
            sleep 5
          done

          echo "Zitadel is ready! Checking for PAT file..."

          # Try to read PAT file from zitadel-0 pod
          if kubectl exec zitadel-0 -- cat /machine-creds/pat 2>/dev/null; then
            echo "PAT file found! Reading credentials..."
            PAT=$(kubectl exec zitadel-0 -- cat /machine-creds/pat)

            if [ -n "$PAT" ]; then
              echo "Creating Kubernetes secret zitadel-k8s-admin-sa..."
              kubectl create secret generic zitadel-k8s-admin-sa \
                --from-literal=token="$PAT" \
                --dry-run=client -o yaml | kubectl apply -f -

              echo "Secret created successfully!"
              exit 0
            else
              echo "ERROR: PAT file is empty"
              exit 1
            fi
          else
            echo "WARNING: PAT file not found in zitadel-0 pod"
            echo "Machine user may not have been created during first startup"
            echo "Check if FIRSTINSTANCE env vars are properly configured"
            exit 1
          fi
