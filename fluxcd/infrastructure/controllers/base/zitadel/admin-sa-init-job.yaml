apiVersion: batch/v1
kind: Job
metadata:
  name: zitadel-admin-sa-init
spec:
  ttlSecondsAfterFinished: 86400
  backoffLimit: 5
  template:
    spec:
      restartPolicy: OnFailure
      serviceAccountName: zitadel
      containers:
      - name: extract-admin-sa
        image: PLACEHOLDER_ALPINE_IMAGE
        command:
        - sh
        - -c
        - |
          set -e
          echo "Installing kubectl and tar..."
          apk add --no-cache curl tar
          curl -LO "https://dl.k8s.io/release/v1.34.0/bin/linux/amd64/kubectl"
          chmod +x kubectl
          mv kubectl /usr/local/bin/

          echo "Checking if secret already exists..."
          if kubectl get secret zitadel-k8s-admin-sa 2>/dev/null; then
            echo "Secret zitadel-k8s-admin-sa already exists, skipping"
            exit 0
          fi

          echo "Waiting for Zitadel pod to be ready..."
          until kubectl get pod zitadel-0 -o jsonpath='{.status.phase}' 2>/dev/null | grep -q "Running"; do
            echo "Waiting for zitadel-0 pod to be running..."
            sleep 10
          done

          echo "Zitadel pod is running! Waiting for it to be ready..."
          until kubectl get pod zitadel-0 -o jsonpath='{.status.containerStatuses[0].ready}' 2>/dev/null | grep -q "true"; do
            echo "Waiting for zitadel-0 container to be ready..."
            sleep 5
          done

          echo "Zitadel is ready! Waiting 30s for FIRSTINSTANCE processing..."
          sleep 30

          echo "Checking for PAT file in zitadel-0..."
          # Use kubectl cp to copy the file since cat doesn't exist in distroless image
          if kubectl cp zitadel-0:/machine-creds/pat /tmp/pat 2>/dev/null; then
            echo "PAT file found! Reading credentials..."
            PAT=$(cat /tmp/pat)

            if [ -n "$PAT" ]; then
              echo "Creating Kubernetes secret zitadel-k8s-admin-sa..."
              kubectl create secret generic zitadel-k8s-admin-sa \
                --from-literal=token="$PAT" \
                --dry-run=client -o yaml | kubectl apply -f -

              echo "Secret created successfully!"
              rm -f /tmp/pat
              exit 0
            else
              echo "ERROR: PAT file is empty"
              rm -f /tmp/pat
              exit 1
            fi
          else
            echo "WARNING: PAT file not found in zitadel-0 pod"
            echo "Machine user may not have been created during first startup"
            echo "Check if FIRSTINSTANCE env vars are properly configured on StatefulSet"
            exit 1
          fi
