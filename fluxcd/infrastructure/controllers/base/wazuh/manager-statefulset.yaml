apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: wazuh-manager
spec:
  serviceName: wazuh-manager
  replicas: 1
  selector:
    matchLabels:
      app: wazuh-manager
  template:
    metadata:
      labels:
        app: wazuh-manager
    spec:
      hostname: wazuh-manager
      securityContext:
        fsGroup: 101
      containers:
      - name: wazuh-manager
        image: PLACEHOLDER_IMAGE
        securityContext:
          capabilities:
            add: ["SYS_CHROOT"]
        ports:
        - containerPort: 1514
          name: agent-events
          protocol: TCP
        - containerPort: 1515
          name: agent-auth
          protocol: TCP
        - containerPort: 514
          name: syslog
          protocol: UDP
        - containerPort: 55000
          name: api
          protocol: TCP
        envFrom:
        - secretRef:
            name: PLACEHOLDER_ENV_SECRET
        volumeMounts:
        - name: wazuh-manager-conf
          mountPath: /wazuh-config-mount/etc/ossec.conf
          subPath: ossec.conf
          readOnly: true
        - name: ssl-certs
          mountPath: /etc/ssl/root-ca.pem
          subPath: root-ca-manager.pem
          readOnly: true
        - name: ssl-certs
          mountPath: /etc/ssl/filebeat.pem
          subPath: wazuh.manager.pem
          readOnly: true
        - name: ssl-certs
          mountPath: /etc/ssl/filebeat.key
          subPath: wazuh.manager-key.pem
          readOnly: true
        - name: wazuh-manager-data
          mountPath: /var/ossec/api/configuration
          subPath: wazuh/var/ossec/api/configuration
        - name: wazuh-manager-data
          mountPath: /var/ossec/etc
          subPath: wazuh/var/ossec/etc
        - name: wazuh-manager-data
          mountPath: /var/ossec/logs
          subPath: wazuh/var/ossec/logs
        - name: wazuh-manager-data
          mountPath: /var/ossec/queue
          subPath: wazuh/var/ossec/queue
        - name: wazuh-manager-data
          mountPath: /var/ossec/var/multigroups
          subPath: wazuh/var/ossec/var/multigroups
        - name: wazuh-manager-data
          mountPath: /var/ossec/integrations
          subPath: wazuh/var/ossec/integrations
        - name: wazuh-manager-data
          mountPath: /var/ossec/active-response/bin
          subPath: wazuh/var/ossec/active-response/bin
        - name: wazuh-manager-data
          mountPath: /var/ossec/agentless
          subPath: wazuh/var/ossec/agentless
        - name: wazuh-manager-data
          mountPath: /var/ossec/wodles
          subPath: wazuh/var/ossec/wodles
        - name: wazuh-manager-data
          mountPath: /var/lib/filebeat
          subPath: filebeat/var/lib/filebeat
        resources:
          requests:
            cpu: PLACEHOLDER_CPU
            memory: PLACEHOLDER_MEMORY
          limits:
            cpu: PLACEHOLDER_CPU_LIMIT
            memory: PLACEHOLDER_MEMORY_LIMIT
      volumes:
      - name: wazuh-manager-conf
        configMap:
          name: PLACEHOLDER_MANAGER_CONFIG
      - name: ssl-certs
        secret:
          secretName: PLACEHOLDER_SSL_SECRET
  volumeClaimTemplates:
  - metadata:
      name: wazuh-manager-data
    spec:
      accessModes: ["ReadWriteOnce"]
      storageClassName: PLACEHOLDER_STORAGE_CLASS
      resources:
        requests:
          storage: PLACEHOLDER_STORAGE_SIZE
