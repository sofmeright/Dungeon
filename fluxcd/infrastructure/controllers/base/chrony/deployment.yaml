apiVersion: apps/v1
kind: Deployment
metadata:
  name: chrony
spec:
  replicas: PLACEHOLDER_REPLICAS
  selector:
    matchLabels:
      app: chrony
  template:
    metadata:
      labels:
        app: chrony
    spec:
      securityContext:
        fsGroup: 101
      initContainers:
      - name: fix-permissions
        image: docker.io/library/alpine:latest
        command: ['sh', '-c', 'chown -R 100:101 /run/chrony /var/lib/chrony /etc/chrony']
        volumeMounts:
        - name: chrony-etc
          mountPath: /etc/chrony
        - name: chrony-run
          mountPath: /run/chrony
        - name: chrony-var
          mountPath: /var/lib/chrony
      containers:
      - name: chrony
        image: PLACEHOLDER_IMAGE
        ports:
        - containerPort: 123
          protocol: UDP
          name: ntp
        envFrom:
        - configMapRef:
            name: chrony-config
        securityContext:
          allowPrivilegeEscalation: false
          readOnlyRootFilesystem: true
          capabilities:
            drop:
            - ALL
            add:
            - NET_BIND_SERVICE
            # Add SYS_TIME only if ENABLE_SYSCLK is true in production overlay
            # - SYS_TIME
        volumeMounts:
        - name: chrony-etc
          mountPath: /etc/chrony
        - name: chrony-run
          mountPath: /run/chrony
        - name: chrony-var
          mountPath: /var/lib/chrony
        # Uncomment if PTP hardware support is needed
        # - name: ptp-device
        #   mountPath: /dev/ptp0
        resources:
          requests:
            memory: "16Mi"
            cpu: "10m"
          limits:
            memory: "64Mi"
            cpu: "100m"
      volumes:
      - name: chrony-etc
        emptyDir:
          medium: Memory
          sizeLimit: 1Mi
      - name: chrony-run
        emptyDir:
          sizeLimit: 1Mi
      - name: chrony-var
        emptyDir:
          medium: Memory
          sizeLimit: 4Mi
      # Uncomment if PTP hardware support is needed
      # - name: ptp-device
      #   hostPath:
      #     path: /dev/ptp0
      #     type: CharDevice
      restartPolicy: Always