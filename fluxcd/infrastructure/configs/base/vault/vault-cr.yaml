apiVersion: vault.banzaicloud.com/v1alpha1
kind: Vault
metadata:
  name: vault
spec:
  size: 3
  image: PLACEHOLDER_VAULT_IMAGE
  bankVaultsImage: ghcr.io/bank-vaults/bank-vaults:v1.32.0

  # Use Kubernetes secrets for unseal keys (SOPS encrypted in source)
  unsealConfig:
    options: {}  # Empty options object required by CRD
    kubernetes:
      secretNamespace: PLACEHOLDER_NAMESPACE
      secretName: vault-unseal-keys

  # Vault configuration for HA with Raft storage
  config:
    storage:
      raft:
        path: /vault/data
        retry_join:
          - leader_api_addr: "http://vault-0.zeldas-lullaby.svc.cluster.local:8200"
          - leader_api_addr: "http://vault-1.zeldas-lullaby.svc.cluster.local:8200"
          - leader_api_addr: "http://vault-2.zeldas-lullaby.svc.cluster.local:8200"
    listener:
      tcp:
        address: "0.0.0.0:8200"
        tls_disable: true
    api_addr: "http://vault.vault:8200"
    cluster_addr: "https://vault.vault:8201"
    ui: true
    disable_mlock: true

  # Volume claim templates for raft storage (one per pod)
  volumeClaimTemplates:
    - metadata:
        name: vault-data
      spec:
        accessModes:
          - ReadWriteOnce
        storageClassName: ceph-rbd
        resources:
          requests:
            storage: 10Gi

  # Volume mounts for raft storage
  volumeMounts:
    - name: vault-data
      mountPath: /vault/data

  # Resources
  resources:
    vault:
      requests:
        memory: "256Mi"
        cpu: "250m"
      limits:
        memory: "512Mi"
        cpu: "500m"

  # Service configuration - disabled, we manage our own
  serviceRegistrationEnabled: false

  # Use the vault service account
  serviceAccount: vault

  # Fix statsd exporter image with full registry path
  statsdImage: docker.jcr.pcfae.com/prom/statsd-exporter:latest

  # Make sure it runs on worker nodes with pod anti-affinity for HA
  affinity:
    nodeAffinity:
      preferredDuringSchedulingIgnoredDuringExecution:
        - weight: 100
          preference:
            matchExpressions:
              - key: node-role.kubernetes.io/worker
                operator: Exists
    podAntiAffinity:
      preferredDuringSchedulingIgnoredDuringExecution:
        - weight: 100
          podAffinityTerm:
            labelSelector:
              matchExpressions:
                - key: app.kubernetes.io/name
                  operator: In
                  values:
                    - vault
            topologyKey: kubernetes.io/hostname