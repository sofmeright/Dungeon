apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: gitlab-smtp-oidc
spec:
  refreshInterval: 1h
  secretStoreRef:
    kind: ClusterSecretStore
    name: PLACEHOLDER_VAULT_CLUSTER_SECRET_STORE
  target:
    name: gitlab-smtp-oidc
    creationPolicy: Owner
    template:
      type: Opaque
      data:
        # SMTP Configuration
        smtp: |
          address: {{ .smtp_address }}
          port: {{ .smtp_port }}
          user_name: {{ .smtp_username }}
          password: {{ .smtp_password }}
          domain: {{ .smtp_domain }}
          authentication: {{ .smtp_authentication }}
          enable_starttls_auto: true
          tls: false
          openssl_verify_mode: peer
        gitlab_email_from: {{ .gitlab_email_from }}
        gitlab_email_reply_to: {{ .gitlab_email_reply_to }}
        # OIDC Configuration
        provider: |
          name: 'openid_connect'
          label: 'PrecisionPlanIT.com'
          icon: 'https://sso.prplanit.com/ui/console/assets/icons/favicon-32x32.png'
          args:
            name: 'openid_connect'
            scope: ['openid', 'profile', 'email']
            response_type: 'code'
            issuer: '{{ .oidc_issuer }}'
            discovery: true
            client_auth_method: 'query'
            uid_field: 'sub'
            client_options:
              identifier: '{{ .oidc_client_id }}'
              secret: '{{ .oidc_client_secret }}'
              redirect_uri: '{{ .oidc_redirect_uri }}'
  data:
  - secretKey: smtp_address
    remoteRef:
      key: apps/gitlab
      property: smtp-address
  - secretKey: smtp_port
    remoteRef:
      key: apps/gitlab
      property: smtp-port
  - secretKey: smtp_username
    remoteRef:
      key: apps/gitlab
      property: smtp-username
  - secretKey: smtp_password
    remoteRef:
      key: apps/gitlab
      property: smtp-password
  - secretKey: smtp_domain
    remoteRef:
      key: apps/gitlab
      property: smtp-domain
  - secretKey: smtp_authentication
    remoteRef:
      key: apps/gitlab
      property: smtp-authentication
  - secretKey: gitlab_email_from
    remoteRef:
      key: apps/gitlab
      property: gitlab-email-from
  - secretKey: gitlab_email_reply_to
    remoteRef:
      key: apps/gitlab
      property: gitlab-email-reply-to
  - secretKey: oidc_client_id
    remoteRef:
      key: apps/gitlab
      property: oidc-client-id
  - secretKey: oidc_client_secret
    remoteRef:
      key: apps/gitlab
      property: oidc-client-secret
  - secretKey: oidc_issuer
    remoteRef:
      key: apps/gitlab
      property: oidc-issuer
  - secretKey: oidc_redirect_uri
    remoteRef:
      key: apps/gitlab
      property: oidc-redirect-uri
