apiVersion: vault.banzaicloud.com/v1alpha1
kind: Vault
metadata:
  name: vault
spec:
  image: docker.io/hashicorp/vault:1.21.3
  envsConfig:
    - name: VAULT_OIDC_CLIENT_SECRET
      valueFrom:
        secretKeyRef:
          name: vault-oidc-credentials
          key: client-secret
  vaultPodSpec:
    imagePullSecrets:
      - name: jcr-pcfae-dungeon-pull-secret
  vaultAnnotations:
    prometheus.io/scrape: "true"
    prometheus.io/port: "9091"
  vaultContainerSpec:
    securityContext:
      capabilities:
        add:
          - IPC_LOCK
          - SETFCAP
  unsealConfig:
    kubernetes:
      secretNamespace: zeldas-lullaby
  vaultConfigurerPodSpec: {}
  externalConfig:
    policies:
      - name: external-secrets
        rules: |
          path "operationtimecapsule/data/*" {
            capabilities = ["read", "list"]
          }
          path "operationtimecapsule/metadata/*" {
            capabilities = ["read", "list"]
          }
          path "precisionplanit/data/*" {
            capabilities = ["read", "list"]
          }
          path "precisionplanit/metadata/*" {
            capabilities = ["read", "list"]
          }
          path "zeldas-letter/data/*" {
            capabilities = ["read", "list"]
          }
          path "zeldas-letter/metadata/*" {
            capabilities = ["read", "list"]
          }
          path "great-sea/data/*" {
            capabilities = ["read", "list"]
          }
          path "great-sea/metadata/*" {
            capabilities = ["read", "list"]
          }
          path "pedestal-of-time/data/*" {
            capabilities = ["read", "list"]
          }
          path "pedestal-of-time/metadata/*" {
            capabilities = ["read", "list"]
          }
      - name: zitadel-provisioner
        rules: |
          path "zeldas-letter/data/apps/zitadel" {
            capabilities = ["create", "update", "read", "patch"]
          }
          path "zeldas-letter/metadata/apps/zitadel" {
            capabilities = ["read", "list"]
          }
      - name: vault-admin
        rules: |
          path "*" {
            capabilities = ["create", "read", "update", "delete", "list", "sudo"]
          }
    auth:
      - type: kubernetes
        config:
          kubernetes_host: https://kubernetes.default.svc.cluster.local
          disable_iss_validation: true
        roles:
          - name: external-secrets
            bound_service_account_names: ["external-secrets-vault"]
            bound_service_account_namespaces: ["zeldas-lullaby"]
            policies: ["external-secrets"]
            ttl: 24h
          - name: zitadel-vault-sync
            bound_service_account_names: ["zitadel"]
            bound_service_account_namespaces: ["zeldas-lullaby"]
            policies: ["zitadel-provisioner"]
            ttl: 1h
      - type: oidc
        config:
          oidc_discovery_url: https://sso.prplanit.com
          oidc_client_id: "360752964924708521"
          oidc_client_secret: '${ env `VAULT_OIDC_CLIENT_SECRET` }'
          default_role: vault-admin
        roles:
          - name: vault-admin
            user_claim: sub
            policies: ["vault-admin"]
            allowed_redirect_uris:
              - https://vault.pcfae.com/ui/vault/auth/oidc/oidc/callback
              - http://localhost:8250/oidc/callback
            oidc_scopes:
              - openid
              - profile
              - email
              - "urn:zitadel:iam:org:project:roles"
            bound_claims:
              roles: "Admin"
    secrets:
      - path: operationtimecapsule
        type: kv
        description: Media and archives secrets
        options:
          version: 2
      - path: precisionplanit
        type: kv
        description: PrecisionPlanIt business secrets
        options:
          version: 2
      - path: zeldas-letter
        type: kv
        description: System and core infrastructure secrets
        options:
          version: 2
      - path: great-sea
        type: kv
        description: VPN-routed media automation secrets
        options:
          version: 2
      - path: pedestal-of-time
        type: kv
        description: Personal productivity and management apps
        options:
          version: 2
