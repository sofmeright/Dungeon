apiVersion: vault.banzaicloud.com/v1alpha1
kind: Vault
metadata:
  name: vault
spec:
  image: docker.io/hashicorp/vault:1.21.3
  vaultPodSpec:
    imagePullSecrets:
      - name: jcr-pcfae-dungeon-pull-secret
  vaultAnnotations:
    prometheus.io/scrape: "true"
    prometheus.io/port: "9091"
  vaultContainerSpec:
    securityContext:
      capabilities:
        add:
          - IPC_LOCK
          - SETFCAP
  unsealConfig:
    kubernetes:
      secretNamespace: zeldas-lullaby
  vaultConfigurerPodSpec: {}
  externalConfig:
    policies:
      - name: external-secrets
        rules: |
          path "operationtimecapsule/data/*" {
            capabilities = ["read", "list"]
          }
          path "operationtimecapsule/metadata/*" {
            capabilities = ["read", "list"]
          }
          path "precisionplanit/data/*" {
            capabilities = ["read", "list"]
          }
          path "precisionplanit/metadata/*" {
            capabilities = ["read", "list"]
          }
          path "zeldas-letter/data/*" {
            capabilities = ["read", "list"]
          }
          path "zeldas-letter/metadata/*" {
            capabilities = ["read", "list"]
          }
          path "great-sea/data/*" {
            capabilities = ["read", "list"]
          }
          path "great-sea/metadata/*" {
            capabilities = ["read", "list"]
          }
          path "pedestal-of-time/data/*" {
            capabilities = ["read", "list"]
          }
          path "pedestal-of-time/metadata/*" {
            capabilities = ["read", "list"]
          }
      - name: zitadel-provisioner
        rules: |
          path "zeldas-letter/data/apps/zitadel" {
            capabilities = ["create", "update", "read", "patch"]
          }
          path "zeldas-letter/metadata/apps/zitadel" {
            capabilities = ["read", "list"]
          }
    auth:
      - type: kubernetes
        config:
          kubernetes_host: https://kubernetes.default.svc.cluster.local
          disable_iss_validation: true
        roles:
          - name: external-secrets
            bound_service_account_names: ["external-secrets-vault"]
            bound_service_account_namespaces: ["zeldas-lullaby"]
            policies: ["external-secrets"]
            ttl: 24h
          - name: zitadel-vault-sync
            bound_service_account_names: ["zitadel"]
            bound_service_account_namespaces: ["zeldas-lullaby"]
            policies: ["zitadel-provisioner"]
            ttl: 1h
    secrets:
      - path: operationtimecapsule
        type: kv
        description: Media and archives secrets
        options:
          version: 2
      - path: precisionplanit
        type: kv
        description: PrecisionPlanIt business secrets
        options:
          version: 2
      - path: zeldas-letter
        type: kv
        description: System and core infrastructure secrets
        options:
          version: 2
      - path: great-sea
        type: kv
        description: VPN-routed media automation secrets
        options:
          version: 2
      - path: pedestal-of-time
        type: kv
        description: Personal productivity and management apps
        options:
          version: 2
