apiVersion: v1
kind: ConfigMap
metadata:
  name: cephfs-setup-script
data:
  cephfs-init-rootpaths.yml: |
    ---
    # CephFS Directory Setup Playbook
    # Usage: ansible-playbook cephfs-init-rootpaths.yml -e "path=/dungeon/hdd/apps/myapp subdirs=data,cache owner=1000:1000 mode=0755"
    - name: CephFS Directory Setup
      hosts: localhost
      connection: local
      gather_facts: false
      vars:
        cephfs_mount: /cephfs
        subdirs: ""
        owner: "1000:1000"
        mode: "0755"
      tasks:
        - name: Validate required variables
          ansible.builtin.assert:
            that:
              - path is defined
            fail_msg: "Required variable: path"

        - name: Parse owner into uid and gid
          ansible.builtin.set_fact:
            owner_uid: "{{ owner.split(':')[0] }}"
            owner_gid: "{{ owner.split(':')[1] }}"

        - name: Display configuration
          ansible.builtin.debug:
            msg: |
              === CephFS Setup ===
              Path: {{ path }}
              Subdirs: {{ subdirs | default('(none)') }}
              Owner: {{ owner_uid }}:{{ owner_gid }}
              Mode: {{ mode }}

        - name: Create base directory
          ansible.builtin.file:
            path: "{{ cephfs_mount }}{{ path }}"
            state: directory
            owner: "{{ owner_uid }}"
            group: "{{ owner_gid }}"
            mode: "{{ mode }}"

        - name: Create subdirectories
          ansible.builtin.file:
            path: "{{ cephfs_mount }}{{ path }}/{{ item }}"
            state: directory
            owner: "{{ owner_uid }}"
            group: "{{ owner_gid }}"
            mode: "{{ mode }}"
          loop: "{{ subdirs.split(',') }}"
          when: subdirs | length > 0

        - name: Setup complete
          ansible.builtin.debug:
            msg: "=== CephFS Setup Complete ==="
