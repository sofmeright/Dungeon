apiVersion: v1
kind: ConfigMap
metadata:
  name: zitadel-config
data:
  zitadel-config.yaml: |
    Log:
      Level: info

    Port: 8080
    ExternalPort: 443
    ExternalDomain: sso.prplanit.com
    ExternalSecure: true

    Database:
      Postgres:
        Host: zitadel-postgres-rw.zeldas-lullaby.svc.cluster.local
        Port: 5432
        Database: zitadel
        User:
          Username: zitadel
          SSL:
            Mode: disable
        Admin:
          Username: postgres
          SSL:
            Mode: disable
        MaxOpenConns: 25
        MaxIdleConns: 10
        MaxConnLifetime: 1h
        MaxConnIdleTime: 5m

    Telemetry:
      Enabled: false

    # FirstInstance configuration for initial instance bootstrap
    # Processed by setup job which creates credentials in emptyDir volumes
    # Sidecar containers extract credentials and create Kubernetes secrets
    FirstInstance:
      Org:
        Machine:
          Machine:
            Username: k8s-admin
            Name: Kubernetes Admin Service Account
          MachineKey:
            ExpirationDate: '2029-01-01T00:00:00Z'
            Type: 1  # JWT
          Pat:
            ExpirationDate: '2029-01-01T00:00:00Z'
        LoginClient:
          Machine:
            Username: login-client
            Name: Login UI Client Service Account
          Pat:
            ExpirationDate: '2029-01-01T00:00:00Z'

    DefaultInstance:
      SMTPConfiguration:
        SMTP:
          Host: smtp.gmail.com:465
          TLS: true
        From: noreply@precisionplan.it
        FromName: PrecisionPlan IT

    SystemDefaults:
      SecretGenerators:
        PasswordSaltCost: 14
      Domain: sso.prplanit.com
      ZitadelDocs:
        Enabled: true
        ExternalDomain: docs.zitadel.com

    # Kubernetes Integration
    Machine:
      Identification:
        Hostname:
          Enabled: true
        Webhook:
          Enabled: false

    # Enable Actions for K8s webhook integration
    Actions:
      HTTP:
        DenyList: []

    # Notifications Configuration (required for v4.3.0+)
    Notifications:
      LegacyEnabled: true
      Workers: 1
      BulkLimit: 10
      RequeueEvery: 5s
      RetryWorkers: 1
      RetryRequeueEvery: 5s
      HandleActiveInstances: 0s
      TransactionDuration: 10s
      MaxAttempts: 3
      MaxTtl: 5m
      MinRetryDelay: 5s
      MaxRetryDelay: 1m
      RetryDelayFactor: 1.5

    # Projections Configuration
    Projections:
      RequeueEvery: 60s
      RetryFailedAfter: 1s
      MaxFailureCount: 5
      BulkLimit: 200
      Customizations: {}