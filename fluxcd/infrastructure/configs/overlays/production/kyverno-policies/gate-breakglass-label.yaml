apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: gate-breakglass-label
spec:
  validationFailureAction: Enforce
  background: false
  rules:
    - name: gate-breakglass-pods
      match:
        any:
          - resources:
              kinds: [Pod]
              namespaces:
                - arylls-lookout
                - compass
                - delivery-bag
                - fairy-bottle
                - gorons-bracelet
                - gossip-stone
                - hookshot
                - hyrule-castle
                - king-of-red-lions
                - kokiri-forest
                - lens-of-truth
                - lost-woods
                - pedestal-of-time
                - shooting-gallery
                - swift-sail
                - temple-of-time
                - tingle-tuner
                - wallmaster
                - zeldas-lullaby
      preconditions:
        all:
          - key: "{{ request.object.metadata.labels.\"zt.breakglass/pod\" || '' }}"
            operator: Equals
            value: "true"
      context:
        - name: clusterGate
          apiCall:
            urlPath: "/api/v1/namespaces/kube-system"
            jmesPath: "metadata.labels.\"zt.breakglass/active\" || 'false'"
        - name: namespaceGate
          apiCall:
            urlPath: "/api/v1/namespaces/{{request.namespace}}"
            jmesPath: "metadata.labels.\"zt.breakglass/namespace\" || 'false'"
      validate:
        message: >-
          Breakglass requires three gates: (1) kube-system labeled
          zt.breakglass/active=true, (2) this namespace labeled
          zt.breakglass/namespace=true, (3) pod labeled zt.breakglass/pod=true.
          Gates 1 and/or 2 are not set.
        deny:
          conditions:
            any:
              - key: "{{ clusterGate }}"
                operator: NotEquals
                value: "true"
              - key: "{{ namespaceGate }}"
                operator: NotEquals
                value: "true"
    - name: gate-breakglass-controllers
      match:
        any:
          - resources:
              kinds: [Deployment, StatefulSet, DaemonSet, Job, CronJob]
              namespaces:
                - arylls-lookout
                - compass
                - delivery-bag
                - fairy-bottle
                - gorons-bracelet
                - gossip-stone
                - hookshot
                - hyrule-castle
                - king-of-red-lions
                - kokiri-forest
                - lens-of-truth
                - lost-woods
                - pedestal-of-time
                - shooting-gallery
                - swift-sail
                - temple-of-time
                - tingle-tuner
                - wallmaster
                - zeldas-lullaby
      preconditions:
        all:
          - key: "{{ request.object.spec.template.metadata.labels.\"zt.breakglass/pod\" || '' }}"
            operator: Equals
            value: "true"
      context:
        - name: clusterGate
          apiCall:
            urlPath: "/api/v1/namespaces/kube-system"
            jmesPath: "metadata.labels.\"zt.breakglass/active\" || 'false'"
        - name: namespaceGate
          apiCall:
            urlPath: "/api/v1/namespaces/{{request.namespace}}"
            jmesPath: "metadata.labels.\"zt.breakglass/namespace\" || 'false'"
      validate:
        message: >-
          Breakglass requires three gates: (1) kube-system labeled
          zt.breakglass/active=true, (2) this namespace labeled
          zt.breakglass/namespace=true, (3) controller pod template labeled
          zt.breakglass/pod=true. Gates 1 and/or 2 are not set.
        deny:
          conditions:
            any:
              - key: "{{ clusterGate }}"
                operator: NotEquals
                value: "true"
              - key: "{{ namespaceGate }}"
                operator: NotEquals
                value: "true"
    - name: expire-stale-breakglass
      match:
        any:
          - resources:
              kinds: [Pod]
              namespaces:
                - arylls-lookout
                - compass
                - delivery-bag
                - fairy-bottle
                - gorons-bracelet
                - gossip-stone
                - hookshot
                - hyrule-castle
                - king-of-red-lions
                - kokiri-forest
                - lens-of-truth
                - lost-woods
                - pedestal-of-time
                - shooting-gallery
                - swift-sail
                - temple-of-time
                - tingle-tuner
                - wallmaster
                - zeldas-lullaby
              operations: [UPDATE]
      preconditions:
        all:
          - key: "{{ request.object.metadata.labels.\"zt.breakglass/pod\" || '' }}"
            operator: Equals
            value: "true"
      context:
        - name: clusterGate
          apiCall:
            urlPath: "/api/v1/namespaces/kube-system"
            jmesPath: "metadata.labels.\"zt.breakglass/active\" || 'false'"
      validate:
        message: >-
          Stale breakglass: pod retains zt.breakglass/pod=true but cluster
          emergency mode (kube-system zt.breakglass/active=true) is no longer
          active. Remove the pod label or re-enable cluster emergency.
        deny:
          conditions:
            any:
              - key: "{{ clusterGate }}"
                operator: NotEquals
                value: "true"
