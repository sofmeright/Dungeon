# Configuration values for Weave GitOps HelmRelease
apiVersion: v1
kind: ConfigMap
metadata:
  name: weave-gitops-values
  namespace: flux-system
data:
  values.yaml: |
    # Admin user configuration
    adminUser:
      create: false  # Disable admin user completely
    
    # Use user-account auth method with external secret
    additionalArgs:
      - --auth-methods=user-account
    
    # RBAC configuration - give ServiceAccount permissions to view resources
    rbac:
      create: true
      viewSecretsResourceNames: ["cluster-user-auth", "oidc-auth"]
      # Add permissions to view Flux and Kubernetes resources
      additionalRules:
        - apiGroups: [""]
          resources: ["namespaces", "pods", "services", "configmaps", "secrets"]
          verbs: ["get", "list", "watch"]
        - apiGroups: ["apps"]
          resources: ["deployments", "replicasets", "statefulsets", "daemonsets"]
          verbs: ["get", "list", "watch"]
        - apiGroups: ["source.toolkit.fluxcd.io"]
          resources: ["*"]
          verbs: ["get", "list", "watch"]
        - apiGroups: ["kustomize.toolkit.fluxcd.io"]
          resources: ["*"]
          verbs: ["get", "list", "watch"]
        - apiGroups: ["helm.toolkit.fluxcd.io"]
          resources: ["*"]
          verbs: ["get", "list", "watch"]
        - apiGroups: ["notification.toolkit.fluxcd.io"]
          resources: ["*"]
          verbs: ["get", "list", "watch"]
    
    # Additional security settings
    metrics:
      enabled: true
    
    # Service configuration - use LoadBalancer with MetalLB
    service:
      type: LoadBalancer
      annotations:
        metallb.universe.tf/loadBalancerIPs: "172.22.30.100"
        metallb.universe.tf/allow-shared-ip: "weave-gitops"
      port: 9001
    
    # Disable ingress since we're using LoadBalancer
    ingress:
      enabled: false