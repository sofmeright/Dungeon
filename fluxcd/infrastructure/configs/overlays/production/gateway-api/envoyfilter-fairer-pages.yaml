apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: fairer-pages-error-handler
  namespace: kokiri-forest
spec:
  workloadSelector:
    labels:
      gateway.networking.k8s.io/gateway-name: phloem-gateway
  configPatches:
    # Add Lua filter for error interception
    - applyTo: HTTP_FILTER
      match:
        context: GATEWAY
        listener:
          filterChain:
            filter:
              name: envoy.filters.network.http_connection_manager
              subFilter:
                name: envoy.filters.http.router
      patch:
        operation: INSERT_BEFORE
        value:
          name: envoy.filters.http.lua
          typed_config:
            "@type": type.googleapis.com/envoy.extensions.filters.http.lua.v3.Lua
            defaultSourceCode:
              inlineString: |
                function envoy_on_request(request_handle)
                  local path = request_handle:headers():get(":path") or ""
                  -- Mark fairer-pages requests to skip error handling
                  if string.match(path, "^/fairer%-pages/") then
                    request_handle:streamInfo():dynamicMetadata():set("fairer_pages", "skip", "true")
                  end
                end

                function envoy_on_response(response_handle)
                  -- Skip if this is a fairer-pages request
                  local skip = response_handle:streamInfo():dynamicMetadata():get("fairer_pages")
                  if skip and skip["skip"] == "true" then
                    return
                  end

                  -- Skip for JSON API responses
                  local content_type = response_handle:headers():get("content-type") or ""
                  if string.match(content_type, "application/json") then
                    return
                  end

                  local status = response_handle:headers():get(":status")
                  local status_num = tonumber(status)

                  -- Error codes to intercept
                  local error_codes = {
                    [400] = true, [401] = true, [403] = true, [404] = true,
                    [405] = true, [408] = true, [410] = true, [429] = true,
                    [500] = true, [502] = true, [503] = true, [504] = true
                  }

                  if error_codes[status_num] then
                    -- Serve error page in-place via iframe â€” preserves browser URL
                    local html = '<!DOCTYPE html><html><head><meta charset="UTF-8">'
                      .. '<title>Error ' .. status .. '</title>'
                      .. '<style>*{margin:0;padding:0}html,body{height:100%%;overflow:hidden}'
                      .. 'iframe{width:100%%;height:100%%;border:none}</style></head>'
                      .. '<body><iframe src="/fairer-pages/playlist/random/'
                      .. status .. '.html"></iframe></body></html>'

                    response_handle:headers():replace("content-type", "text/html; charset=utf-8")
                    response_handle:headers():remove("content-encoding")
                    response_handle:headers():replace("content-length", tostring(#html))
                    response_handle:headers():add("cache-control", "no-cache, no-store, must-revalidate")
                    response_handle:headers():add("x-original-status", status)

                    local body = response_handle:body()
                    if body then
                      body:setBytes(html)
                    end
                  end
                end
