apiVersion: batch/v1
kind: Job
metadata:
  name: gitlab-s3-setup
  namespace: gorons-bracelet
spec:
  ttlSecondsAfterFinished: 86400
  template:
    spec:
      restartPolicy: OnFailure
      containers:
      - name: s3-setup
        image: docker.jcr.pcfae.com/library/python:3.11-alpine
        env:
        - name: ADMIN_ACCESSKEY
          valueFrom:
            secretKeyRef:
              name: rgw-admin-ops-user
              key: accessKey
        - name: ADMIN_SECRETKEY
          valueFrom:
            secretKeyRef:
              name: rgw-admin-ops-user
              key: secretKey
        - name: GITLAB_ACCESSKEY
          valueFrom:
            secretKeyRef:
              name: gitlab-s3-credentials
              key: access_key
        - name: GITLAB_SECRETKEY
          valueFrom:
            secretKeyRef:
              name: gitlab-s3-credentials
              key: secret_key
        command:
        - /bin/sh
        - -c
        - |
          set -e

          echo "Installing dependencies..."
          pip install --no-cache-dir boto3 requests-aws4auth

          cat > /tmp/gitlab_s3_setup.py << 'EOFPYTHON'
          import boto3
          import sys
          from botocore.client import Config
          from botocore.exceptions import ClientError

          RGW_ENDPOINT = "http://ceph-rgw.gorons-bracelet.svc.cluster.local:80"

          def create_user(admin_access, admin_secret, gitlab_access, gitlab_secret):
              """Create GitLab RGW user via Admin API"""
              import requests
              from requests_aws4auth import AWS4Auth

              auth = AWS4Auth(admin_access, admin_secret, 'us-east-1', 's3')

              url = f"{RGW_ENDPOINT}/admin/user"
              params = {
                  'uid': 'gitlab',
                  'display-name': 'GitLab S3 User',
                  'access-key': gitlab_access,
                  'secret-key': gitlab_secret
              }

              try:
                  resp = requests.put(url, params=params, auth=auth)
                  if resp.status_code == 200:
                      print("✓ GitLab RGW user created successfully")
                      return True
                  elif 'UserAlreadyExists' in resp.text or 'EntityAlreadyExists' in resp.text:
                      print("✓ GitLab RGW user already exists")
                      return True
                  else:
                      print(f"⚠ User creation response: {resp.status_code} - {resp.text}")
                      print("  Assuming user exists, continuing...")
                      return True
              except Exception as e:
                  print(f"⚠ User creation failed: {e}")
                  print("  Assuming user exists, continuing...")
                  return True

          def create_bucket(access_key, secret_key, bucket_name):
              """Create S3 bucket"""
              s3 = boto3.client(
                  's3',
                  endpoint_url=RGW_ENDPOINT,
                  aws_access_key_id=access_key,
                  aws_secret_access_key=secret_key,
                  config=Config(signature_version='s3v4')
              )

              try:
                  s3.head_bucket(Bucket=bucket_name)
                  print(f"✓ Bucket '{bucket_name}' already exists")
                  return True
              except ClientError as e:
                  if e.response['Error']['Code'] == '404':
                      s3.create_bucket(Bucket=bucket_name)
                      print(f"✓ Bucket '{bucket_name}' created successfully")
                      return True
                  else:
                      print(f"✗ Bucket '{bucket_name}' check failed: {e}")
                      return False

          if __name__ == '__main__':
              import os
              admin_access = os.environ['ADMIN_ACCESSKEY']
              admin_secret = os.environ['ADMIN_SECRETKEY']
              gitlab_access = os.environ['GITLAB_ACCESSKEY']
              gitlab_secret = os.environ['GITLAB_SECRETKEY']

              print("Creating GitLab RGW user via Admin API...")
              create_user(admin_access, admin_secret, gitlab_access, gitlab_secret)

              buckets = ['gitlab-lfs', 'gitlab-artifacts', 'gitlab-uploads', 'gitlab-packages',
                         'gitlab-backups', 'gitlab-tmp', 'gitlab-registry']

              print("\nCreating GitLab S3 buckets...")
              all_success = True
              for bucket in buckets:
                  if not create_bucket(gitlab_access, gitlab_secret, bucket):
                      all_success = False

              if all_success:
                  print("\n✓ GitLab S3 setup complete!")
                  sys.exit(0)
              else:
                  print("\n✗ Some buckets failed to create")
                  sys.exit(1)
          EOFPYTHON

          python /tmp/gitlab_s3_setup.py
