apiVersion: batch/v1
kind: Job
metadata:
  name: harbor-rgw-setup
spec:
  ttlSecondsAfterFinished: 86400
  template:
    spec:
      restartPolicy: OnFailure
      containers:
        - name: setup
          image: quay.io/ceph/ceph:v19
          env:
            - name: HARBOR_ACCESS_KEY
              valueFrom:
                secretKeyRef:
                  name: harbor-rgw-credentials
                  key: access_key
            - name: HARBOR_SECRET_KEY
              valueFrom:
                secretKeyRef:
                  name: harbor-rgw-credentials
                  key: secret_key
          command:
            - /bin/bash
            - -c
            - |
              set -ex

              # Wait for RGW to be ready (use client.dungeon-rgw keyring)
              until radosgw-admin --name client.dungeon-rgw user list 2>/dev/null; do
                echo "Waiting for RGW to be accessible..."
                sleep 5
              done

              # Create S3 user for Harbor if it doesn't exist
              # NOTE: UID must differ from bucket name to avoid RGW object collision
              if ! radosgw-admin --name client.dungeon-rgw user info --uid=harbor-sa 2>/dev/null; then
                echo "Creating Harbor S3 user..."
                radosgw-admin --name client.dungeon-rgw user create \
                  --uid=harbor-sa \
                  --display-name="Harbor Container Registry Service Account" \
                  --access-key="${HARBOR_ACCESS_KEY}" \
                  --secret-key="${HARBOR_SECRET_KEY}"
              else
                echo "Harbor S3 user already exists"
              fi

              # Install s3cmd for bucket creation
              dnf install -y s3cmd

              # Configure s3cmd (signature_v2 needed for Ceph RGW)
              printf '%s\n' \
                "[default]" \
                "access_key = ${HARBOR_ACCESS_KEY}" \
                "secret_key = ${HARBOR_SECRET_KEY}" \
                "host_base = ceph-rgw.gorons-bracelet.svc.cluster.local" \
                "host_bucket = ceph-rgw.gorons-bracelet.svc.cluster.local/%(bucket)" \
                "use_https = False" \
                "signature_v2 = True" \
                > /root/.s3cfg

              # Create harbor-registry bucket
              if ! s3cmd ls s3://harbor-registry 2>/dev/null; then
                echo "Creating bucket: harbor-registry"
                s3cmd mb s3://harbor-registry
              else
                echo "Bucket already exists: harbor-registry"
              fi

              echo "Harbor RGW setup complete"
          volumeMounts:
            - name: ceph-config
              mountPath: /etc/ceph/ceph.conf
              subPath: ceph.conf
              readOnly: true
            - name: ceph-keyring
              mountPath: /etc/ceph/ceph.client.dungeon-rgw.keyring
              subPath: keyring
              readOnly: true
      volumes:
        - name: ceph-config
          configMap:
            name: ceph-config
        - name: ceph-keyring
          secret:
            secretName: ceph-rgw-keyring
