apiVersion: batch/v1
kind: Job
metadata:
  name: harbor-rgw-setup
spec:
  ttlSecondsAfterFinished: 86400
  template:
    spec:
      restartPolicy: OnFailure
      containers:
        - name: setup
          image: quay.io/ceph/ceph:v19
          env:
            - name: HARBOR_ACCESS_KEY
              valueFrom:
                secretKeyRef:
                  name: harbor-rgw-credentials
                  key: access_key
            - name: HARBOR_SECRET_KEY
              valueFrom:
                secretKeyRef:
                  name: harbor-rgw-credentials
                  key: secret_key
          command:
            - /bin/bash
            - -c
            - |
              set -ex

              # Wait for RGW to be ready
              until radosgw-admin user list 2>/dev/null; do
                echo "Waiting for RGW to be accessible..."
                sleep 5
              done

              # Create S3 user for Harbor if it doesn't exist
              if ! radosgw-admin user info --uid=harbor 2>/dev/null; then
                echo "Creating Harbor S3 user..."
                radosgw-admin user create \
                  --uid=harbor \
                  --display-name="Harbor Container Registry" \
                  --access-key="${HARBOR_ACCESS_KEY}" \
                  --secret-key="${HARBOR_SECRET_KEY}"
              else
                echo "Harbor S3 user already exists"
              fi

              # Install s3cmd for bucket creation
              dnf install -y s3cmd

              # Configure s3cmd
              cat > /root/.s3cfg <<EOF
              [default]
              access_key = ${HARBOR_ACCESS_KEY}
              secret_key = ${HARBOR_SECRET_KEY}
              host_base = ceph-rgw.gorons-bracelet.svc.cluster.local
              host_bucket = ceph-rgw.gorons-bracelet.svc.cluster.local/%(bucket)
              use_https = False
              EOF

              # Create harbor bucket
              if ! s3cmd ls s3://harbor 2>/dev/null; then
                echo "Creating bucket: harbor"
                s3cmd mb s3://harbor
              else
                echo "Bucket already exists: harbor"
              fi

              echo "Harbor S3 setup complete"
          volumeMounts:
            - name: ceph-config
              mountPath: /etc/ceph/ceph.conf
              subPath: ceph.conf
              readOnly: true
            - name: ceph-keyring
              mountPath: /etc/ceph/ceph.keyring
              subPath: keyring
              readOnly: true
      volumes:
        - name: ceph-config
          configMap:
            name: ceph-config
        - name: ceph-keyring
          secret:
            secretName: ceph-rgw-keyring
