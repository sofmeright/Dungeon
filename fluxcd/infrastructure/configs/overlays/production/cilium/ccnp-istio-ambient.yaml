apiVersion: "cilium.io/v2"
kind: CiliumClusterwideNetworkPolicy
metadata:
  name: allow-istio-ambient
spec:
  description: >-
    Allows Istio Ambient ztunnel traffic cluster-wide.
    HBONE (port 15008) is the mTLS tunnel used for all pod-to-pod
    communication in ambient mode. Also allows kubelet health probes
    which get SNAT'd to 169.254.7.127 by Istio's iptables rules.
    enableDefaultDeny is false so this policy purely adds allow rules
    without triggering default-deny on endpoints that have no other policies.
  enableDefaultDeny:
    egress: false
    ingress: false
  endpointSelector: {}
  ingress:
    # Allow HBONE mTLS tunnel traffic (ztunnel pod-to-pod)
    # Port 15008 is inherently authenticated via mTLS - only ztunnel
    # instances with valid SPIFFE identities can establish connections
    - toPorts:
        - ports:
            - port: "15008"
              protocol: TCP
    # Allow kubelet health probes SNAT'd by Istio ambient iptables
    # Istio rewrites probe source IP to 169.254.7.127 which Cilium
    # doesn't recognize as the host identity
    # See: https://istio.io/latest/docs/ambient/install/platform-prerequisites/
    - fromCIDR:
        - "169.254.7.127/32"
  egress:
    # Allow outbound HBONE mTLS tunnel traffic
    - toPorts:
        - ports:
            - port: "15008"
              protocol: TCP
