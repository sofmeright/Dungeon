apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: appflowy-postgres-init-sql
spec:
  refreshInterval: 1h
  secretStoreRef:
    kind: ClusterSecretStore
    name: PLACEHOLDER_SECRET_STORE
  target:
    name: appflowy-postgres-init-sql
    template:
      data:
        init.sql: |
          -- Create supabase_admin_auth user (Helm chart naming convention)
          DO $$
          BEGIN
            IF NOT EXISTS (
              SELECT FROM pg_catalog.pg_roles WHERE rolname = 'supabase_admin_auth'
            ) THEN
              CREATE USER supabase_admin_auth
                BYPASSRLS NOINHERIT CREATEROLE LOGIN NOREPLICATION
                PASSWORD '{{ .SUPABASE_PASSWORD }}';
            END IF;
          END $$;
        app-init.sql: |
          -- Grant permissions on appflowy database
          GRANT ALL PRIVILEGES ON DATABASE appflowy TO supabase_admin_auth;

          -- Create pgvector extension only
          -- Let gotrue migrations create the auth schema
          CREATE EXTENSION IF NOT EXISTS vector;
  dataFrom:
  - extract:
      key: PLACEHOLDER_VAULT_KEY
