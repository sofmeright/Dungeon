apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: appflowy-postgres-init-sql
spec:
  refreshInterval: 1h
  secretStoreRef:
    kind: ClusterSecretStore
    name: PLACEHOLDER_SECRET_STORE
  target:
    name: appflowy-postgres-init-sql
    template:
      data:
        init.sql: |
          -- No init required - CloudNativePG creates appflowy user and database
        app-init.sql: |
          -- Create pgvector extension (matches Helm chart setup)
          CREATE EXTENSION IF NOT EXISTS vector;

          -- Change ownership of auth schema and enum types to appflowy user
          -- This allows gotrue migrations to modify these objects
          ALTER SCHEMA auth OWNER TO appflowy;
          ALTER TYPE auth.aal_level OWNER TO appflowy;
          ALTER TYPE auth.factor_status OWNER TO appflowy;
          ALTER TYPE auth.factor_type OWNER TO appflowy;
  dataFrom:
  - extract:
      key: PLACEHOLDER_VAULT_KEY
