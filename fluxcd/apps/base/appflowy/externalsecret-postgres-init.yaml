apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: appflowy-postgres-init-sql
spec:
  refreshInterval: 1h
  secretStoreRef:
    kind: ClusterSecretStore
    name: PLACEHOLDER_SECRET_STORE
  target:
    name: appflowy-postgres-init-sql
    template:
      data:
        init.sql: |
          -- Make appflowy user superuser
          ALTER USER appflowy WITH SUPERUSER;

          -- Create supabase_auth_admin user
          DO $$
          BEGIN
            IF NOT EXISTS (
              SELECT FROM pg_catalog.pg_roles WHERE rolname = 'supabase_auth_admin'
            ) THEN
              CREATE USER supabase_auth_admin
                BYPASSRLS NOINHERIT CREATEROLE LOGIN NOREPLICATION
                PASSWORD '{{ .SUPABASE_PASSWORD }}';
            END IF;
          END $$;

          -- Create auth schema
          CREATE SCHEMA IF NOT EXISTS auth AUTHORIZATION supabase_auth_admin;

          -- Set search_path
          ALTER USER supabase_auth_admin SET search_path = 'auth';
  dataFrom:
  - extract:
      key: PLACEHOLDER_VAULT_KEY
