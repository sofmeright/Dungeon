# Ad-hoc job template for manual hasteward operations.
# Edit args + env vars per run, then apply:
#   kubectl apply -f <overlay-rendered> or flux reconcile
#
# Subcommands: triage, repair, backup, restore, export, prune, get
#
# Environment variables:
#   HASTEWARD_ENGINE=<cnpg|galera>          (required)
#   HASTEWARD_CLUSTER=<name>                (required)
#   HASTEWARD_NAMESPACE=<ns>                (required)
#   HASTEWARD_BACKUPS_PATH=/backups         (required for repair/backup/restore)
#   RESTIC_PASSWORD=<password>              (required for backup/restore/repair)
#   HASTEWARD_INSTANCE=<N>                  (optional, repair only)
#   HASTEWARD_FORCE=true                    (optional, targeted repair only)
#   HASTEWARD_NO_ESCROW=true                (optional, skip escrow)
#   HASTEWARD_BACKUP_METHOD=<dump|native>   (optional, default: dump)
apiVersion: batch/v1
kind: Job
metadata:
  name: hasteward-run
  labels:
    app.kubernetes.io/name: hasteward
spec:
  ttlSecondsAfterFinished: 3600
  backoffLimit: 0
  template:
    metadata:
      labels:
        app.kubernetes.io/name: hasteward
    spec:
      serviceAccountName: hasteward
      restartPolicy: Never
      containers:
        - name: hasteward
          image: PLACEHOLDER_IMAGE
          args: ["PLACEHOLDER_SUBCOMMAND"]
          env:
            - name: HASTEWARD_ENGINE
              value: PLACEHOLDER_ENGINE
            - name: HASTEWARD_CLUSTER
              value: PLACEHOLDER_CLUSTER
            - name: HASTEWARD_NAMESPACE
              value: PLACEHOLDER_NAMESPACE
            - name: HASTEWARD_BACKUPS_PATH
              value: /backups
          volumeMounts:
            - name: backups
              mountPath: /backups
      volumes:
        - name: backups
          persistentVolumeClaim:
            claimName: hasteward-backups
