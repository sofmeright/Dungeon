apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: homarr-redis
  labels:
    app: homarr-redis
spec:
  serviceName: homarr-redis-headless
  replicas: PLACEHOLDER_REPLICAS
  selector:
    matchLabels:
      app: homarr-redis
  template:
    metadata:
      labels:
        app: homarr-redis
    spec:
      initContainers:
        - name: config
          image: PLACEHOLDER_REDIS_IMAGE
          env:
            - name: REDIS_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: homarr-redis-password
                  key: password
          command:
            - sh
            - -c
            - |
              set -ex
              # Copy base config
              cp /tmp/redis/redis.conf /etc/redis/redis.conf

              NAMESPACE="NAMESPACE_PLACEHOLDER"
              MY_HOSTNAME=$(hostname)
              SENTINEL_HOST="homarr-sentinel.${NAMESPACE}.svc.cluster.local"

              # Map pod IPs to DNS names for all Redis pods
              nodes="homarr-redis-0 homarr-redis-1 homarr-redis-2"

              # Try to get master from sentinel first
              MASTER_IP=""
              MASTER_PORT=""
              if redis-cli -h "$SENTINEL_HOST" -p 26379 ping 2>/dev/null | grep -q PONG; then
                echo "Sentinel is reachable, querying for master..."
                MASTER_INFO=$(redis-cli -h "$SENTINEL_HOST" -p 26379 SENTINEL get-master-addr-by-name homarr-redis 2>/dev/null || echo "")
                if [ -n "$MASTER_INFO" ]; then
                  MASTER_IP=$(echo "$MASTER_INFO" | head -1)
                  MASTER_PORT=$(echo "$MASTER_INFO" | tail -1)
                  echo "Sentinel reports master at $MASTER_IP:$MASTER_PORT"
                fi
              fi

              # Find which pod is the master by checking each node
              MASTER_POD=""
              if [ -n "$MASTER_IP" ]; then
                # Resolve master IP to pod name
                for pod in $nodes; do
                  POD_FQDN="${pod}.homarr-redis-headless.${NAMESPACE}.svc.cluster.local"
                  POD_IP=$(getent hosts "$POD_FQDN" 2>/dev/null | awk '{print $1}' || echo "")
                  if [ "$POD_IP" = "$MASTER_IP" ]; then
                    MASTER_POD=$pod
                    echo "Master IP $MASTER_IP resolves to pod $MASTER_POD"
                    break
                  fi
                done
              fi

              # If sentinel didn't help, probe each node directly
              if [ -z "$MASTER_POD" ]; then
                echo "Probing nodes directly to find master..."
                for pod in $nodes; do
                  POD_FQDN="${pod}.homarr-redis-headless.${NAMESPACE}.svc.cluster.local"
                  ROLE=$(redis-cli -h "$POD_FQDN" -a "$REDIS_PASSWORD" --no-auth-warning info replication 2>/dev/null | grep "role:" | cut -d: -f2 | tr -d '\r\n' || echo "")
                  if [ "$ROLE" = "master" ]; then
                    MASTER_POD=$pod
                    echo "Found master at $MASTER_POD via direct probe"
                    break
                  fi
                done
              fi

              # If still no master and this is first startup, redis-0 becomes initial master
              if [ -z "$MASTER_POD" ]; then
                MASTER_POD="homarr-redis-0"
                echo "No master found (fresh cluster), defaulting to $MASTER_POD"
              fi

              # Configure as replica if we're not the master
              if [ "$MY_HOSTNAME" != "$MASTER_POD" ]; then
                MASTER_FQDN="${MASTER_POD}.homarr-redis-headless.${NAMESPACE}.svc.cluster.local"
                echo "replicaof $MASTER_FQDN 6379" >> /etc/redis/redis.conf
                echo "Configured as replica of $MASTER_FQDN"
              else
                echo "This node ($MY_HOSTNAME) is the master"
              fi

              echo "Configuration complete for $MY_HOSTNAME"
              cat /etc/redis/redis.conf
          volumeMounts:
            - name: redis-config-template
              mountPath: /tmp/redis
            - name: config
              mountPath: /etc/redis
      containers:
        - name: redis
          image: PLACEHOLDER_REDIS_IMAGE
          command:
            - redis-server
            - /etc/redis/redis.conf
            - --requirepass
            - $(REDIS_PASSWORD)
            - --masterauth
            - $(REDIS_PASSWORD)
          ports:
            - name: redis
              containerPort: 6379
              protocol: TCP
          env:
            - name: REDIS_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: homarr-redis-password
                  key: password
          volumeMounts:
            - name: data
              mountPath: /data
            - name: config
              mountPath: /etc/redis
          resources:
            requests:
              cpu: 100m
              memory: 128Mi
            limits:
              cpu: 500m
              memory: 256Mi
          livenessProbe:
            tcpSocket:
              port: redis
            initialDelaySeconds: 30
            periodSeconds: 10
          readinessProbe:
            exec:
              command:
                - sh
                - -c
                - |
                  # Only ready if this is the master (for -rw service routing)
                  redis-cli -a "$REDIS_PASSWORD" info replication 2>/dev/null | grep -q "role:master"
            initialDelaySeconds: 5
            periodSeconds: 5
            failureThreshold: 3
      volumes:
        - name: redis-config-template
          configMap:
            name: homarr-redis-config
        - name: config
          emptyDir: {}
  volumeClaimTemplates:
    - metadata:
        name: data
      spec:
        accessModes:
          - ReadWriteOnce
        storageClassName: PLACEHOLDER_STORAGE_CLASS
        resources:
          requests:
            storage: PLACEHOLDER_STORAGE_SIZE
