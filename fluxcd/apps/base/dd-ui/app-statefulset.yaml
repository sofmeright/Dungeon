apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: dd-ui
spec:
  serviceName: dd-ui
  replicas: 1
  selector:
    matchLabels:
      app: dd-ui
  template:
    metadata:
      labels:
        app: dd-ui
    spec:
      containers:
      - name: dd-ui
        image: docker.io/prplanit/dd-ui:v0.7.5
        ports:
        - containerPort: 443
          name: https
        env:
        # General Config
        - name: DD_UI_LOCAL_HOST
          value: anchorage
        - name: DD_UI_LOG_LEVEL
          value: debug
        - name: DD_UI_UI_ORIGIN
          value: https://dd-ui-dev.pcfae.com

        # Authentication / OIDC
        - name: DD_UI_COOKIE_SECURE
          value: "true"
        - name: DD_UI_COOKIE_DOMAIN
          value: dd-ui.pcfae.com
        - name: OIDC_CLIENT_ID
          valueFrom:
            secretKeyRef:
              name: dd-ui-secrets
              key: oidc-client-id
        - name: OIDC_CLIENT_SECRET
          valueFrom:
            secretKeyRef:
              name: dd-ui-secrets
              key: oidc-client-secret
        - name: OIDC_ISSUER_URL
          value: https://sso.prplanit.com
        - name: OIDC_REDIRECT_URL
          value: https://dd-ui-dev.pcfae.com/auth/callback
        - name: OIDC_POST_LOGOUT_REDIRECT_URL
          value: https://dd-ui-dev.pcfae.com/login
        - name: OIDC_SCOPES
          value: openid email profile

        # Database (Postgres) Configuration
        - name: DD_UI_DB_HOST
          value: dd-ui-postgres
        - name: DD_UI_DB_PORT
          value: "5432"
        - name: DD_UI_DB_NAME
          value: dd-ui
        - name: DD_UI_DB_USER
          value: prplanit
        - name: DD_UI_DB_PASS
          valueFrom:
            secretKeyRef:
              name: dd-ui-secrets
              key: postgres-password
        - name: DD_UI_DB_SSLMODE
          value: disable
        - name: DD_UI_DB_MIGRATE
          value: "true"

        # Docker Connection Config
        - name: DOCKER_CONNECTION_METHOD
          value: ssh

        # Encryption / SOPS Config
        - name: DD_UI_ALLOW_SOPS_DECRYPT
          value: "true"
        - name: SOPS_AGE_KEY
          valueFrom:
            secretKeyRef:
              name: dd-ui-secrets
              key: sops-age-key
        - name: DDUI_SESSION_SECRET
          valueFrom:
            secretKeyRef:
              name: dd-ui-secrets
              key: session-secret

        # SSH Config
        - name: SSH_USER
          value: kai
        - name: SSH_PORT
          value: "22"
        - name: SSH_USE_SUDO
          value: "false"
        - name: SSH_STRICT_HOST_KEY
          value: "false"

        # Auto DevOps Config
        - name: DDUI_DEVOPS_APPLY
          value: "false"

        # Scanning Config - Docker Host(s) States
        - name: DD_UI_SCAN_DOCKER_AUTO
          value: "true"
        - name: DD_UI_SCAN_DOCKER_INTERVAL
          value: 1m
        - name: DD_UI_SCAN_DOCKER_HOST_TIMEOUT
          value: 45s
        - name: DD_UI_SCAN_DOCKER_CONCURRENCY
          value: "3"
        - name: DD_UI_SCAN_DOCKER_ON_START
          value: "true"
        - name: DD_UI_SCAN_DOCKER_DEBUG
          value: "true"

        # Scanning Config - IAC
        - name: DD_UI_IAC_ROOT
          value: /data
        - name: DD_UI_DOCKER_DIR
          value: docker-compose
        - name: DD_UI_INVENTORY_FILE
          value: ansible/inventory.yaml
        - name: DD_UI_SCAN_IAC_AUTO
          value: "true"
        - name: DD_UI_SCAN_IAC_INTERVAL
          value: 90s

        # Theming
        - name: DD_UI_THEME_BG
          value: "#0b1220"
        - name: DD_UI_THEME_SURFACE
          value: "#0f172a"
        - name: D_DUI_THEME_TEXT
          value: "#1f2937"
        - name: DD_UI_THEME_TEXT_MUTED
          value: "#94a3b8"
        - name: DD_UI_THEME_DANGER
          value: "#FF001EFF"
        - name: DD_UI_THEME_INFO
          value: "#310937"

        volumeMounts:
        - name: data
          mountPath: /data
        - name: ssh-key
          mountPath: /run/secrets/ssh_key
          subPath: ssh-key
          readOnly: true
      volumes:
      - name: ssh-key
        secret:
          secretName: dd-ui-secrets
          items:
          - key: ssh-key
            path: ssh-key
            mode: 0600
  volumeClaimTemplates:
  - metadata:
      name: data
    spec:
      accessModes:
      - ReadWriteOnce
      resources:
        requests:
          storage: 50Gi
