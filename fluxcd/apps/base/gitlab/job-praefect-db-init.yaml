apiVersion: batch/v1
kind: Job
metadata:
  name: gitlab-praefect-db-init
spec:
  ttlSecondsAfterFinished: 300
  template:
    spec:
      restartPolicy: OnFailure
      containers:
      - name: init-praefect-db
        image: docker.io/library/postgres:16
        env:
        - name: PGHOST
          value: PLACEHOLDER_DB_HOST
        - name: PGPORT
          value: "5432"
        - name: PGUSER
          value: gitlab
        - name: PGDATABASE
          value: gitlabhq_production
        - name: PGPASSWORD
          valueFrom:
            secretKeyRef:
              name: gitlab-postgresql-credentials
              key: password
        - name: PRAEFECT_PASSWORD
          valueFrom:
            secretKeyRef:
              name: gitlab-praefect-credentials
              key: password
        command:
        - /bin/bash
        - -c
        - |
          set -e

          # Connect as postgres superuser via peer authentication on the pod
          export PGHOST=PLACEHOLDER_DB_HOST
          export PGPORT=5432

          echo "Connecting to PostgreSQL to set up Praefect database..."

          # Use psql with the postgres command to execute as superuser
          kubectl exec -n hyrule-castle gitlab-postgresql-1 -- psql -U postgres <<EOF
          -- Check if praefect user exists, create if not
          DO \$\$
          BEGIN
            IF NOT EXISTS (SELECT 1 FROM pg_roles WHERE rolname = 'praefect') THEN
              CREATE USER praefect WITH PASSWORD '$PRAEFECT_PASSWORD';
              RAISE NOTICE 'User praefect created';
            ELSE
              RAISE NOTICE 'User praefect already exists';
            END IF;
          END
          \$\$;

          -- Check if praefect database exists, create if not
          SELECT 'CREATE DATABASE praefect OWNER praefect'
          WHERE NOT EXISTS (SELECT FROM pg_database WHERE datname = 'praefect')\gexec

          -- Grant privileges
          GRANT ALL PRIVILEGES ON DATABASE praefect TO praefect;
          EOF

          echo "Praefect database setup complete!"
