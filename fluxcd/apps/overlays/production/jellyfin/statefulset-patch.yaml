# Patch to use static RBD volumes (volumeClaimTemplates removed via JSON patch)
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: jellyfin
spec:
  template:
    metadata:
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "8096"
    spec:
      securityContext:
        fsGroup: 1000
        runAsUser: 1000
        runAsGroup: 1000
      initContainers:
        - name: fix-permissions
          image: docker.io/busybox:1.36
          securityContext:
            runAsUser: 0
            runAsGroup: 0
          command:
            - sh
            - -c
            - |
              chown -R 1000:1000 /config || true
              chown -R 1000:1000 /cache || true
          volumeMounts:
            - name: config
              mountPath: /config
            - name: cache
              mountPath: /cache
      containers:
        - name: jellyfin
          image: docker.io/jellyfin/jellyfin:10.11.6
          env:
            - name: JELLYFIN_PublishedServerUrl
              value: "https://jfish.optcp.com"
          volumeMounts:
            - name: config
              mountPath: /config
            - name: cache
              mountPath: /cache
      volumes:
        - name: config
          persistentVolumeClaim:
            claimName: optcp-jellyfin-config
        - name: cache
          persistentVolumeClaim:
            claimName: optcp-jellyfin-cache
        - name: media-movies
          persistentVolumeClaim:
            claimName: jellyfin-media-movies
        - name: media-tv
          persistentVolumeClaim:
            claimName: jellyfin-media-tv
        - name: media-music
          persistentVolumeClaim:
            claimName: jellyfin-media-music
        - name: media-photos
          persistentVolumeClaim:
            claimName: jellyfin-media-photos
