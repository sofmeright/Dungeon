apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
namespace: shooting-gallery
resources:
- ../../../base/ark-asa
nameSuffix: -theisland
patches:
- patch: |-
    - op: add
      path: /spec/template/metadata/labels/map
      value: theisland
    - op: replace
      path: /spec/template/spec/containers/0/ports
      value:
      - containerPort: 8777
        protocol: UDP
        name: game
      - containerPort: 8777
        protocol: TCP
        name: game-tcp
      - containerPort: 28020
        protocol: TCP
        name: rcon
      - containerPort: 28015
        protocol: UDP
        name: query
    - op: add
      path: /spec/template/spec/containers/0/env/-
      value:
        name: INSTANCE_NAME
        value: theisland
    - op: add
      path: /spec/template/spec/containers/0/env/-
      value:
        name: TZ
        value: America/Los_Angeles
    - op: add
      path: /spec/template/spec/containers/0/env/-
      value:
        name: MAP_NAME
        value: TheIsland_WP
    - op: add
      path: /spec/template/spec/containers/0/env/-
      value:
        name: SESSION_NAME
        value: ARK Survival Ascended - The Island
    - op: add
      path: /spec/template/spec/containers/0/env/-
      value:
        name: ASA_PORT
        value: "8777"
    - op: add
      path: /spec/template/spec/containers/0/env/-
      value:
        name: RCON_PORT
        value: "28020"
    - op: add
      path: /spec/template/spec/containers/0/env/-
      value:
        name: MAX_PLAYERS
        value: "70"
    - op: add
      path: /spec/template/spec/containers/0/env/-
      value:
        name: CLUSTER_ID
        value: dungeon-asa-cluster
    - op: add
      path: /spec/template/spec/containers/0/resources
      value:
        limits:
          memory: 16Gi
        requests:
          memory: 12Gi
          cpu: 2000m
    - op: replace
      path: /spec/volumeClaimTemplates/0/spec/resources/requests/storage
      value: 50Gi
  target:
    kind: StatefulSet
    name: ark-asa
- patch: |-
    - op: replace
      path: /spec/type
      value: LoadBalancer
    - op: add
      path: /metadata/annotations
      value:
        lbipam.cilium.io/ips: "172.22.30.231"
        lbipam.cilium.io/sharing-key: shooting-gallery
    - op: replace
      path: /spec/ports
      value:
      - port: 8777
        targetPort: 8777
        protocol: UDP
        name: game
      - port: 8777
        targetPort: 8777
        protocol: TCP
        name: game-tcp
      - port: 28020
        targetPort: 28020
        protocol: TCP
        name: rcon
      - port: 28015
        targetPort: 28015
        protocol: UDP
        name: query
  target:
    kind: Service
    name: ark-asa
