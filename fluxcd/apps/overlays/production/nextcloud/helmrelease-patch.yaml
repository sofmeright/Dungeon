apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: nextcloud
spec:
  chart:
    spec:
      version: "8.9.1"
  values:
    image:
      tag: "31.0.10"

    replicaCount: 3

    nextcloud:
      host: ncloud.optcp.com
      trustedDomains:
        - ncloud.optcp.com
        - ncloud.pcfae.com

      mail:
        enabled: true
        fromAddress: ncloud
        domain: gmail.com
        smtp:
          host: smtp.gmail.com
          secure: tls
          port: 587
          authtype: LOGIN

      extraEnv:
        - name: TRUSTED_PROXIES
          value: "192.168.144.0/20"
        - name: OVERWRITECLIURL
          value: "https://ncloud.optcp.com"
        - name: OVERWRITEPROTOCOL
          value: "https"
        - name: PHP_MEMORY_LIMIT
          value: "1G"
        - name: PHP_UPLOAD_LIMIT
          value: "16G"

      objectStore:
        s3:
          enabled: true
          host: ceph-rgw.gorons-bracelet.svc.cluster.local
          bucket: nextcloud
          port: "80"
          ssl: false
          region: us-east-1
          usePathStyle: true
          autoCreate: false
          existingSecret: nextcloud-secrets
          secretKeys:
            accessKey: OBJECTSTORE_S3_KEY
            secretKey: OBJECTSTORE_S3_SECRET

      defaultConfigs:
        imaginary.config.php: true

      configs:
        cron.config.php: |-
          <?php
          $CONFIG = array(
            'backgroundjobs_mode' => 'cron',
          );
        session.config.php: |-
          <?php
          if (getenv('REDIS_HOST')) {
            ini_set('session.save_handler', 'redis');
            ini_set('session.save_path',
              'tcp://' . getenv('REDIS_HOST') . ':'
              . (getenv('REDIS_HOST_PORT') ?: '6379')
              . '?auth=' . getenv('REDIS_HOST_PASSWORD')
            );
          }

      strategy:
        type: RollingUpdate
        rollingUpdate:
          maxUnavailable: 1
          maxSurge: 0

    externalDatabase:
      host: nextcloud-postgres-rw
      database: nextcloud

    externalRedis:
      host: nextcloud-redis-master

    persistence:
      enabled: true
      existingClaim: nextcloud-html

    cronjob:
      enabled: true
      type: sidecar

    startupProbe:
      initialDelaySeconds: 30
      periodSeconds: 10
      failureThreshold: 30

    livenessProbe:
      initialDelaySeconds: 120
      periodSeconds: 30

    readinessProbe:
      initialDelaySeconds: 30
      periodSeconds: 15

    resources:
      requests:
        cpu: 200m
        memory: 512Mi
      limits:
        cpu: 2
        memory: 2Gi

    collabora:
      enabled: true
      fullnameOverride: nextcloud-collabora
      image:
        repository: docker.io/collabora/code
        tag: "25.04.7.2.1"
      collabora:
        aliasgroups:
          - host: "https://ncloud.optcp.com:443"
        server_name: ncloud.optcp.com
        extra_params: "--o:ssl.enable=false --o:ssl.termination=true"
      securityContext:
        capabilities:
          add:
            - MKNOD
            - FOWNER
            - SYS_CHROOT
        allowPrivilegeEscalation: true

    service:
      port: 80

    imaginary:
      enabled: true
