apiVersion: v1
kind: ConfigMap
metadata:
  name: speedtest-tracker-nginx
data:
  default.conf: |
    ## Non-root override - listen on 8080 instead of 80
    server {
        listen 8080 default_server;
        listen [::]:8080 default_server;

        server_name _;

        set $root /app/www/public;
        if (!-d /app/www/public) {
            set $root /config/www;
        }
        root $root;
        index index.html index.htm index.php;

        location / {
            try_files $uri $uri/ /index.html /index.htm /index.php$is_args$args;
        }

        location ~ ^(.+\.php)(.*)$ {
            fastcgi_split_path_info ^(.+\.php)(.*)$;
            if (!-f $document_root$fastcgi_script_name) { return 404; }
            fastcgi_pass 127.0.0.1:9000;
            fastcgi_index index.php;
            include /etc/nginx/fastcgi_params;
        }

        # Deny access to .htaccess/.htpasswd files
        location ~ /\.ht {
            deny all;
        }
    }
