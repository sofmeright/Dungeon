apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: open-webui
spec:
  template:
    spec:
      containers:
      - name: open-webui
        image: ghcr.io/open-webui/open-webui:latest
        env:
        - name: POSTGRES_PASSWORD
          valueFrom:
            secretKeyRef:
              name: open-webui-postgres-credentials
              key: password
        - name: REDIS_PASSWORD
          valueFrom:
            secretKeyRef:
              name: open-webui-redis-password
              key: password
        - name: DATABASE_URL
          value: "postgresql://openwebui:$(POSTGRES_PASSWORD)@open-webui-postgres-rw.temple-of-time.svc.cluster.local:5432/openwebui"
        - name: REDIS_URL
          value: "redis://:$(REDIS_PASSWORD)@open-webui-redis:6379/0"
        - name: REDIS_SENTINEL_HOSTS
          value: "open-webui-sentinel-0.open-webui-sentinel-headless.temple-of-time.svc.cluster.local,open-webui-sentinel-1.open-webui-sentinel-headless.temple-of-time.svc.cluster.local,open-webui-sentinel-2.open-webui-sentinel-headless.temple-of-time.svc.cluster.local"
        - name: REDIS_SENTINEL_PORT
          value: "26379"
        - name: WEBSOCKET_REDIS_URL
          value: "redis://:$(REDIS_PASSWORD)@open-webui-redis:6379/0"
        - name: WEBSOCKET_SENTINEL_HOSTS
          value: "open-webui-sentinel-0.open-webui-sentinel-headless.temple-of-time.svc.cluster.local,open-webui-sentinel-1.open-webui-sentinel-headless.temple-of-time.svc.cluster.local,open-webui-sentinel-2.open-webui-sentinel-headless.temple-of-time.svc.cluster.local"
        - name: WEBSOCKET_SENTINEL_PORT
          value: "26379"
        - name: ENABLE_WEBSOCKET_SUPPORT
          value: "true"
        - name: WEBSOCKET_MANAGER
          value: "redis"
        volumeMounts:
        - $patch: delete
          name: PLACEHOLDER_DATA
        - name: temple-of-time-open-webui-data
          mountPath: /app/backend/data
        resources:
          requests:
            cpu: "500m"
            memory: "1Gi"
          limits:
            cpu: "2000m"
            memory: "4Gi"
  volumeClaimTemplates:
  - metadata:
      name: temple-of-time-open-webui-data
    spec:
      accessModes:
      - ReadWriteOnce
      storageClassName: ceph-rbd
      resources:
        requests:
          storage: 10Gi
