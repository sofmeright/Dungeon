apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: netalertx
spec:
  replicas: 1
  template:
    spec:
      securityContext:
        fsGroup: 20211
      containers:
        - name: netalertx
          image: ghcr.io/jokob-sk/netalertx:25.11.29
          ports:
            - containerPort: 20211
              name: http
              hostPort: 20211
          securityContext:
            capabilities:
              drop:
                - ALL
              add:
                - NET_RAW
                - NET_ADMIN
                - NET_BIND_SERVICE
          env:
            - name: PORT
              value: "20211"
            - name: TZ
              value: "America/Los_Angeles"
          volumeMounts:
            - $patch: replace
            # /data root for runtime files
            - name: data
              mountPath: /data
            # Post-migration: only /data mounts with subPaths
            - name: gossip-stone-netalertx-config
              mountPath: /data/config
              subPath: data/config
            - name: gossip-stone-netalertx-sqlite
              mountPath: /data/db
              subPath: data/db
            - name: tmp
              mountPath: /tmp
            - name: localtime
              mountPath: /etc/localtime
              readOnly: true
          resources:
            requests:
              cpu: 100m
              memory: 256Mi
            limits:
              cpu: 1000m
              memory: 1Gi
      volumes:
        - $patch: replace
        - name: data
          emptyDir: {}
        - name: tmp
          emptyDir:
            medium: Memory
        - name: localtime
          hostPath:
            path: /etc/localtime
            type: File
  volumeClaimTemplates:
    - metadata:
        name: gossip-stone-netalertx-config
      spec:
        accessModes: ["ReadWriteOnce"]
        storageClassName: ceph-rbd-retain
        resources:
          requests:
            storage: 1Gi
    - metadata:
        name: gossip-stone-netalertx-sqlite
      spec:
        accessModes: ["ReadWriteOnce"]
        storageClassName: ceph-rbd-retain
        resources:
          requests:
            storage: 2Gi
