apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: quay-secrets
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: vault-zeldas-letter
    kind: ClusterSecretStore
  target:
    name: quay-secrets
    creationPolicy: Owner
    template:
      data:
        postgres_user: "{{ .postgres_user }}"
        postgres_password: "{{ .postgres_password }}"
        postgres_db: "{{ .postgres_db }}"
        redis_password: "{{ .redis_password }}"
        minio_root_user: "{{ .minio_root_user }}"
        minio_root_password: "{{ .minio_root_password }}"
        minio_secret_key: "{{ .minio_secret_key }}"
        default_pass: "{{ .default_pass }}"
        config.yaml: |
          FEATURE_USER_INITIALIZE: true
          BROWSER_API_CALLS_XHR_ONLY: false
          SUPER_USERS:
          - admin
          FEATURE_USER_CREATION: true

          DATABASE_SECRET_KEY: {{ .postgres_password }}
          DB_URI: postgresql://{{ .postgres_user }}:{{ .postgres_password }}@quay-postgres:5432/{{ .postgres_db }}

          BUILDLOGS_REDIS:
            host: quay-redis
            port: 6379
            password: {{ .redis_password }}

          USER_EVENTS_REDIS:
            host: quay-redis
            port: 6379
            password: {{ .redis_password }}

          DISTRIBUTED_STORAGE_CONFIG:
            default:
              - S3Storage
              - s3_access_key: {{ .minio_root_user }}
                s3_secret_key: {{ .minio_root_password }}
                s3_bucket: quay
                storage_path: /datastorage/registry
                host: quay-minio
                port: 9002
                s3_encrypt: false

          DISTRIBUTED_STORAGE_DEFAULT_LOCATIONS: []
          DISTRIBUTED_STORAGE_PREFERENCE:
            - default

          PREFERRED_URL_SCHEME: http
          SERVER_HOSTNAME: quay.prplanit.com
  data: []
  dataFrom:
  - extract:
      key: apps/quay
