apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
namespace: hookshot
resources:
  - ../../../base/tacticalrmm
  - httproute.yaml
  - cephfs-pvs.yaml
patches:
  # ExternalSecrets
  - path: externalsecret-patch.yaml
    target:
      kind: ExternalSecret
      name: tacticalrmm-secrets
  - path: externalsecret-tls-patch.yaml
    target:
      kind: ExternalSecret
      name: tacticalrmm-meshcentral-tls
  # SecretStore (kubernetes provider for TLS cert mirroring)
  - path: secretstore-kubernetes-patch.yaml
    target:
      kind: SecretStore
      name: kubernetes-hyrule-castle
  # RBAC (resourceNames patch — namespace corrected via replacements below)
  - target:
      kind: Role
      name: tacticalrmm-tls-reader
    patch: |-
      - op: replace
        path: /rules/0/resourceNames
        value: ["prplanit-com-tls"]
  # Database StatefulSets
  - path: statefulset-postgres-patch.yaml
    target:
      kind: StatefulSet
      name: tactical-postgres
  - path: statefulset-redis-patch.yaml
    target:
      kind: StatefulSet
      name: tactical-redis
  - path: statefulset-mongodb-patch.yaml
    target:
      kind: StatefulSet
      name: tactical-mongodb
  # Application Deployments
  - path: deployment-backend-patch.yaml
    target:
      kind: Deployment
      name: tactical-backend
  - path: deployment-frontend-patch.yaml
    target:
      kind: Deployment
      name: tactical-frontend
  - path: deployment-websockets-patch.yaml
    target:
      kind: Deployment
      name: tactical-websockets
  - path: deployment-celery-patch.yaml
    target:
      kind: Deployment
      name: tactical-celery
  - path: deployment-celerybeat-patch.yaml
    target:
      kind: Deployment
      name: tactical-celerybeat
  - path: deployment-nats-patch.yaml
    target:
      kind: Deployment
      name: tactical-nats
  - path: deployment-meshcentral-patch.yaml
    target:
      kind: Deployment
      name: tactical-meshcentral
  - path: deployment-nginx-patch.yaml
    target:
      kind: Deployment
      name: tactical-nginx
  # Services
  - path: service-meshcentral-patch.yaml
    target:
      kind: Service
      name: tactical-meshcentral
  - path: service-tactical-nginx-ingress-patch.yaml
    target:
      kind: Service
      name: tactical-nginx

# Replacements run after the namespace transformer, so they can correct the
# RBAC namespace from hookshot → hyrule-castle. Both values are derived from
# existing resources (no magic strings).
replacements:
  # Role/RoleBinding namespace: derived from SecretStore.remoteNamespace
  - source:
      kind: SecretStore
      name: kubernetes-hyrule-castle
      fieldPath: spec.provider.kubernetes.remoteNamespace
    targets:
      - select:
          kind: Role
          name: tacticalrmm-tls-reader
        fieldPaths:
          - metadata.namespace
      - select:
          kind: RoleBinding
          name: tacticalrmm-tls-reader
        fieldPaths:
          - metadata.namespace
  # RoleBinding subject namespace must point to hookshot (where the SA lives).
  # The namespace transformer doesn't touch placeholder strings in subjects,
  # so we derive it from the ServiceAccount's actual namespace.
  - source:
      kind: ServiceAccount
      name: tacticalrmm-tls-reader
      fieldPath: metadata.namespace
    targets:
      - select:
          kind: RoleBinding
          name: tacticalrmm-tls-reader
        fieldPaths:
          - subjects.0.namespace
