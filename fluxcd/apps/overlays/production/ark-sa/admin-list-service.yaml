---
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: ark-sa-tmc-admin-list-source
spec:
  refreshInterval: 30s
  secretStoreRef:
    name: vault-operationtimecapsule
    kind: ClusterSecretStore
  target:
    name: ark-sa-tmc-admin-list-source
    creationPolicy: Owner
  data:
    - secretKey: AdminListURL
      remoteRef:
        key: apps/ark-sa-tmc
        property: AdminListURL
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: ark-sa-tmc-admin-list-njs
data:
  admin-list.js: |
    import fs from 'fs';

    function parseAdminList(text) {
      var steamIds = {};
      if (!text) return steamIds;

      var lines = text.split('\n');
      for (var i = 0; i < lines.length; i++) {
        var line = lines[i].trim();
        if (!line || line.startsWith('#')) continue;

        var match = line.match(/^([0-9a-f]{32})\s*(#.*)?$/i);
        if (match) {
          var steamId = match[1].toLowerCase();
          var comment = match[2] || '';
          steamIds[steamId] = comment;
        }
      }

      return steamIds;
    }

    function mergeAdminLists(lists) {
      var merged = {};
      for (var i = 0; i < lists.length; i++) {
        var list = lists[i];
        for (var steamId in list) {
          if (!merged[steamId]) {
            merged[steamId] = list[steamId];
          }
        }
      }
      return merged;
    }

    function formatAdminList(steamIds) {
      var lines = [];
      for (var steamId in steamIds) {
        lines.push(steamId);
      }
      return lines.join('\n') + '\n';
    }

    function assembleAdminList(r) {
      try {
        var secretPath = '/vault-data';
        var files = fs.readdirSync(secretPath);
        var lists = [];

        for (var i = 0; i < files.length; i++) {
          try {
            var content = fs.readFileSync(secretPath + '/' + files[i], 'utf8');
            var parsed = parseAdminList(content);
            var hasEntries = false;
            for (var key in parsed) {
              hasEntries = true;
              break;
            }
            if (hasEntries) {
              lists.push(parsed);
            }
          } catch (e) {
            // Skip files that can't be read
          }
        }

        var merged = mergeAdminLists(lists);
        var output = formatAdminList(merged);

        r.headersOut['Content-Type'] = 'text/plain';
        r.return(200, output);
      } catch (error) {
        r.return(500, 'Error: ' + error.message + '\n');
      }
    }

    export default { assembleAdminList };
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: ark-sa-tmc-admin-list-nginx-conf
data:
  nginx.conf: |
    load_module modules/ngx_http_js_module.so;

    events {
      worker_connections 1024;
    }

    http {
      js_path "/etc/nginx/njs/";
      js_import admin from admin-list.js;

      server {
        listen 80;
        server_name _;

        location /AllowedCheaterSteamIDs.txt {
          js_content admin.assembleAdminList;
        }

        location /PlayersJoinNoCheckList.txt {
          js_content admin.assembleAdminList;
        }

        location /PlayersExclusiveJoinList.txt {
          js_content admin.assembleAdminList;
        }

        location / {
          return 404 "Not Found\n";
        }
      }
    }
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: ark-sa-tmc-admin-list-server
spec:
  replicas: 1
  selector:
    matchLabels:
      app: ark-sa-tmc-admin-list-server
  template:
    metadata:
      labels:
        app: ark-sa-tmc-admin-list-server
      annotations:
        vault-data-version: "1"
    spec:
      serviceAccountName: ark-sa-tmc-admin-list-server
      containers:
        - name: nginx
          image: docker.io/library/nginx:alpine
          ports:
            - containerPort: 80
              name: http
          volumeMounts:
            - name: nginx-conf
              mountPath: /etc/nginx/nginx.conf
              subPath: nginx.conf
            - name: njs-script
              mountPath: /etc/nginx/njs
            - name: vault-data
              mountPath: /vault-data
              readOnly: true
      volumes:
        - name: nginx-conf
          configMap:
            name: ark-sa-tmc-admin-list-nginx-conf
        - name: njs-script
          configMap:
            name: ark-sa-tmc-admin-list-njs
        - name: vault-data
          secret:
            secretName: ark-sa-tmc-admin-list-source
---
apiVersion: v1
kind: Service
metadata:
  name: ark-sa-tmc-admin-list-server
  annotations:
    lbipam.cilium.io/ips: "172.22.30.231"
    lbipam.cilium.io/sharing-key: "shooting-gallery"
spec:
  type: LoadBalancer
  selector:
    app: ark-sa-tmc-admin-list-server
  ports:
    - port: 28019
      targetPort: 80
      protocol: TCP
      name: http
