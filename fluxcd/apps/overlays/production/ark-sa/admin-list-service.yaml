---
apiVersion: v1
kind: ConfigMap
metadata:
  name: ark-sa-tmc-admin-updater-script
data:
  update-admin-lists.sh: |
    #!/bin/sh
    set -e

    echo "Fetching admin Steam IDs from Vault..."
    VAULT_ADDR="http://172.22.30.86:8200"
    ADMIN_LIST_URL=$(vault kv get -mount=operationtimecapsule -field=AdminListURL apps/ark-sa-tmc 2>/dev/null || echo "")

    if [ -z "$ADMIN_LIST_URL" ]; then
      echo "ERROR: AdminListURL not found in Vault"
      exit 1
    fi

    echo "Generating admin list files..."
    echo "$ADMIN_LIST_URL" > /usr/share/nginx/html/AllowedCheaterSteamIDs.txt
    echo "$ADMIN_LIST_URL" > /usr/share/nginx/html/PlayersJoinNoCheckList.txt
    echo "$ADMIN_LIST_URL" > /usr/share/nginx/html/PlayersExclusiveJoinList.txt

    echo "Admin lists updated at $(date)"
    ls -lh /usr/share/nginx/html/*.txt
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: ark-sa-tmc-admin-list-server
spec:
  replicas: 1
  selector:
    matchLabels:
      app: ark-sa-tmc-admin-list-server
  template:
    metadata:
      labels:
        app: ark-sa-tmc-admin-list-server
    spec:
      initContainers:
      - name: vault-init
        image: docker.jcr.pcfae.com/hashicorp/vault:1.18.3
        command:
        - /bin/sh
        - /scripts/update-admin-lists.sh
        env:
        - name: VAULT_ADDR
          value: "http://172.22.30.86:8200"
        - name: VAULT_TOKEN
          valueFrom:
            secretKeyRef:
              name: vault-token
              key: token
        volumeMounts:
        - name: admin-updater-script
          mountPath: /scripts
        - name: html
          mountPath: /usr/share/nginx/html
      containers:
      - name: nginx
        image: docker.jcr.pcfae.com/library/nginx:alpine
        ports:
        - containerPort: 80
          name: http
        volumeMounts:
        - name: html
          mountPath: /usr/share/nginx/html
      - name: vault-updater
        image: docker.jcr.pcfae.com/hashicorp/vault:1.18.3
        command:
        - /bin/sh
        - -c
        - |
          while true; do
            /scripts/update-admin-lists.sh
            sleep 30
          done
        env:
        - name: VAULT_ADDR
          value: "http://172.22.30.86:8200"
        - name: VAULT_TOKEN
          valueFrom:
            secretKeyRef:
              name: vault-token
              key: token
        volumeMounts:
        - name: admin-updater-script
          mountPath: /scripts
        - name: html
          mountPath: /usr/share/nginx/html
      volumes:
      - name: admin-updater-script
        configMap:
          name: ark-sa-tmc-admin-updater-script
          defaultMode: 0755
      - name: html
        emptyDir: {}
---
apiVersion: v1
kind: Service
metadata:
  name: ark-sa-tmc-admin-list-server
  annotations:
    lbipam.cilium.io/ips: "172.22.30.231"
    lbipam.cilium.io/sharing-key: "shooting-gallery"
spec:
  type: LoadBalancer
  selector:
    app: ark-sa-tmc-admin-list-server
  ports:
  - port: 28019
    targetPort: 80
    protocol: TCP
    name: http
