---
apiVersion: v1
kind: PersistentVolume
metadata:
  name: cephfs-root-temp
spec:
  capacity:
    storage: 1Gi
  accessModes:
    - ReadWriteMany
  persistentVolumeReclaimPolicy: Retain
  csi:
    driver: gorons-bracelet.cephfs.csi.ceph.com
    nodeStageSecretRef:
      name: csi-cephfs-node
      namespace: gorons-bracelet
    volumeAttributes:
      clusterID: 0985467c-d8f3-4483-b27f-f0a512397ec2
      fsName: Seed_Bank
      staticVolume: "true"
      rootPath: /
    volumeHandle: cephfs-root-temp
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: cephfs-root-temp-pvc
spec:
  accessModes:
    - ReadWriteMany
  resources:
    requests:
      storage: 1Gi
  volumeName: cephfs-root-temp
  storageClassName: ""
---
apiVersion: batch/v1
kind: Job
metadata:
  name: ark-sa-tmc-cephfs-init
spec:
  ttlSecondsAfterFinished: 300
  template:
    spec:
      restartPolicy: OnFailure
      initContainers:
      - name: mkdir-structure
        image: docker.io/alpine:latest
        command:
        - /bin/sh
        - -c
        - |
          set -e
          echo "Creating directory structure in CephFS..."
          mkdir -p /cephfs/dungeon/nvme/games/ark-sa/serverfiles
          mkdir -p /cephfs/dungeon/nvme/games/ark-sa/cluster

          echo "Setting ownership to UID/GID 7777 (pok)..."
          chown -R 7777:7777 /cephfs/dungeon/nvme/games/ark-sa

          echo "Setting permissions..."
          chmod -R 755 /cephfs/dungeon/nvme/games/ark-sa

          echo "Directory structure created successfully!"
        volumeMounts:
        - name: cephfs-root
          mountPath: /cephfs
      containers:
      - name: set-permissions
        image: docker.io/alpine:latest
        command:
        - /bin/sh
        - -c
        - |
          set -e
          echo "Setting permissions on serverfiles (UID/GID 7777 - pok)..."
          chown 7777:7777 /serverfiles
          chmod 755 /serverfiles

          echo "Setting permissions on cluster (UID/GID 7777 - pok)..."
          chown 7777:7777 /cluster
          chmod 755 /cluster

          echo "Verifying structure..."
          ls -la /serverfiles
          ls -la /cluster

          echo "ARK CephFS initialization complete!"
        volumeMounts:
        - name: serverfiles
          mountPath: /serverfiles
        - name: cluster
          mountPath: /cluster
      volumes:
      - name: cephfs-root
        persistentVolumeClaim:
          claimName: cephfs-root-temp-pvc
      - name: serverfiles
        persistentVolumeClaim:
          claimName: ark-sa-serverfiles-pvc
      - name: cluster
        persistentVolumeClaim:
          claimName: ark-sa-cluster-pvc
