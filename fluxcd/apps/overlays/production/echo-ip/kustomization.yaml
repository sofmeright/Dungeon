apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: compass

resources:
  - ../../../base/echo-ip

patches:
  - path: statefulset-patch.yaml
    target:
      kind: StatefulSet
      name: echo-ip
  - patch: |-
      - op: add
        path: /metadata/annotations
        value:
          lbipam.cilium.io/ips: "172.22.30.122"
          lbipam.cilium.io/sharing-key: "compass"
      - op: replace
        path: /spec/type
        value: LoadBalancer
      - op: replace
        path: /spec/ports/0/port
        value: 80
    target:
      kind: Service
      name: echo-ip
  - path: externalsecret-patch.yaml
    target:
      kind: ExternalSecret
      name: echo-ip-secrets
  - patch: |-
      - op: replace
        path: /spec/jobTemplate/spec/template/spec/containers/0/volumeMounts
        value:
        - name: compass-echo-ip-data
          mountPath: /usr/share/GeoIP
      - op: replace
        path: /spec/jobTemplate/spec/template/spec/volumes
        value:
        - name: compass-echo-ip-data
          persistentVolumeClaim:
            claimName: compass-echo-ip-data-echo-ip-0
    target:
      kind: CronJob
      name: echo-ip-geoip-update
