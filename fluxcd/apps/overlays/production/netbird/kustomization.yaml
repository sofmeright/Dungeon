apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: zeldas-lullaby

resources:
- ../../../base/netbird

patches:
# PostgreSQL patches
- target:
    kind: StatefulSet
    name: netbird-postgres
  patch: |-
    - op: replace
      path: /spec/template/spec/containers/0/image
      value: docker.jcr.pcfae.com/postgres:15
    - op: replace
      path: /spec/volumeClaimTemplates/0/metadata/name
      value: zeldas-lullaby-netbird-postgres-data
    - op: replace
      path: /spec/template/spec/containers/0/volumeMounts/0/name
      value: zeldas-lullaby-netbird-postgres-data
    - op: replace
      path: /spec/volumeClaimTemplates/0/spec/storageClassName
      value: ceph-rbd

# Management patches
- target:
    kind: StatefulSet
    name: netbird-management
  patch: |-
    - op: replace
      path: /spec/template/spec/containers/0/image
      value: docker.jcr.pcfae.com/netbirdio/management:latest
    - op: replace
      path: /spec/volumeClaimTemplates/0/metadata/name
      value: zeldas-lullaby-netbird-management-data
    - op: replace
      path: /spec/template/spec/containers/0/volumeMounts/0/name
      value: zeldas-lullaby-netbird-management-data
    - op: replace
      path: /spec/volumeClaimTemplates/0/spec/storageClassName
      value: ceph-rbd

# Signal patches
- target:
    kind: StatefulSet
    name: netbird-signal
  patch: |-
    - op: replace
      path: /spec/template/spec/containers/0/image
      value: docker.jcr.pcfae.com/netbirdio/signal:latest
    - op: replace
      path: /spec/volumeClaimTemplates/0/metadata/name
      value: zeldas-lullaby-netbird-signal-data
    - op: replace
      path: /spec/template/spec/containers/0/volumeMounts/0/name
      value: zeldas-lullaby-netbird-signal-data
    - op: replace
      path: /spec/volumeClaimTemplates/0/spec/storageClassName
      value: ceph-rbd

# Relay patches
- target:
    kind: StatefulSet
    name: netbird-relay
  patch: |-
    - op: replace
      path: /spec/template/spec/containers/0/image
      value: docker.jcr.pcfae.com/netbirdio/relay:latest

# Dashboard patches
- target:
    kind: StatefulSet
    name: netbird-dashboard
  patch: |-
    - op: replace
      path: /spec/template/spec/containers/0/image
      value: docker.jcr.pcfae.com/netbirdio/dashboard:latest

# Coturn patches
- target:
    kind: StatefulSet
    name: netbird-coturn
  patch: |-
    - op: replace
      path: /spec/template/spec/containers/0/image
      value: docker.jcr.pcfae.com/coturn/coturn:latest

# Coturn LoadBalancer service patches
- target:
    kind: Service
    name: netbird-coturn
  patch: |-
    - op: add
      path: /metadata/annotations
      value:
        lbipam.cilium.io/ips: "172.22.30.86"
        lbipam.cilium.io/sharing-key: "zeldas-lullaby"

# External LoadBalancer service patches
- target:
    kind: Service
    name: netbird-external
  patch: |-
    - op: add
      path: /metadata/annotations
      value:
        lbipam.cilium.io/ips: "172.22.30.86"
        lbipam.cilium.io/sharing-key: "zeldas-lullaby"

# HTTPRoute patches
- target:
    kind: HTTPRoute
    name: netbird
  patch: |-
    - op: replace
      path: /spec/parentRefs/0/name
      value: cell-membrane-gateway
    - op: replace
      path: /spec/parentRefs/0/namespace
      value: hyrule-castle
    - op: replace
      path: /spec/hostnames/0
      value: netbird.prplanit.com
