# version: '3'
services:

  ghost_app:
    container_name: ghost_app
    depends_on:
    - ghost-mysql
    env_file: ghost-app-secret.env
    environment:
      # see https://ghost.org/docs/config/#configuration-options
      database__client: mysql
      database__connection__host: ghost-mysql
      # database__connection__user: $MYSQL_USER_NAME
      # database__connection__password: $MYSQL_USER_PASS
      database__connection__database: ghost_db
      mail__transport: SMTP
      mail__options__service: Google
      mail__options__host: smtp.gmail.com
      mail__options__port: 465
      mail__options__secure: true
      # mail__options__auth__user: $SMTP_EMAIL
      # mail__options__auth__pass: $SMTP_TOKEN
      # mail__from: $SMTP_EMAIL
      mail__options__secure_connection: true
      privacy__useUpdateCheck: true
      privacy__useGravatar: true
      privacy__useRpcPing: true
      privacy__useStructuredData: true
      # this url value is just an example, and is likely wrong for your environment!
      url: https://blog.sofmeright.com/
      # contrary to the default mentioned in the linked documentation, this image defaults to NODE_ENV=production (so development mode needs to be explicitly specified if desired)
      #NODE_ENV: development
    image: ghost:5-alpine
    links:
    - ghost-mysql
    ports:
      - 9095:2368
    restart: always
    volumes:
      - /opt/docker/ghost/data:/var/lib/ghost/content
    logging: &logging
      driver: "loki"
      options:
        loki-batch-size: "400"
        loki-url: "http://monitoring:3100/loki/api/v1/push"
        max-size: "10m"
        max-file: "3"
        mode: "non-blocking"
        loki-retries: "2"
        loki-max-backoff: "800ms"
        loki-timeout: "1s"

  ghost-mysql:
    logging: *logging
    container_name: ghost-mysql
    image: mysql:8.0
    restart: always
    env_file: ghost-mysql-secret.env
    environment:
    - MYSQL_DATABASE=ghost_db
    # - MYSQL_USER=$MYSQL_USER_USER
    # - MYSQL_PASSWORD=$MYSQL_USER_PASS
    # - MYSQL_ROOT_PASSWORD=$MYSQL_ROOT_PASS
    - MYSQL_ROOT_HOST=%
    volumes:
      - /opt/docker/ghost/mysql:/var/lib/mysql

  linkstack-app:
    logging: *logging
    container_name: linkstack-app
    depends_on:
      - linkstack-mariadb
    env_file: linkstack-app-secret.env
    environment:
      # - SERVER_ADMIN=$ADMIN_EMAIL
      - HTTP_SERVER_NAME=ls.sofmeright.com
      - HTTPS_SERVER_NAME=ls.sofmeright.com
      - TZ=Etc/UTC
      - PUID=1000
      - PGID=1000
      - LOG_LEVEL=info
      - PHP_MEMORY_LIMIT=512M
      - UPLOAD_MAX_FILESIZE=16M
    image: linkstackorg/linkstack:latest
    ports:
      - 40323:443
    restart: always
    volumes:
      - /opt/docker/linkstack/htdocs:/htdocs
      #- linkstack:/htdocs

  linkstack-mariadb:
    logging: *logging
    container_name: linkstack-mariadb
    env_file: linkstack-mariadb-secret.env
    environment:
      - TZ=Etc/UTC
      # - MYSQL_USER=$MYSQL_USER_NAME
      # - MYSQL_PASSWORD=$MYSQL_USER_PASS
      # - MYSQL_DATABASE=$MYSQL_DATABASE
      # - MYSQL_ROOT_PASSWORD=$MYSQL_ROOT_PASS
      - TERM=dumb
    image: mariadb
    restart: always
    volumes:
      #- /opt/docker/linkstack/backups:/docker-entrypoint-initdb.d
      - /opt/docker/linkstack/mysql:/var/lib/mysql
  
#volumes:
#  linkstack: