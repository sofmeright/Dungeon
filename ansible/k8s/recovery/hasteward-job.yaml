---
# hasteward-job.yaml - Run HASteward as a Kubernetes Job
#
# Single Go binary â€” no init container, no Ansible runtime.
# Backups use restic for block-level dedup, encryption, and compression.
#
# Repository: https://gitlab.prplanit.com/precisionplanit/hasteward
#             https://github.com/sofmeright/hasteward
#
# For automated scheduling, use the operator instead:
#   hasteward serve (see deploy/operator/)
#
# Prerequisites (one-time):
#   kubectl apply -f hasteward-job.yaml -l app.kubernetes.io/component=rbac
#   kubectl apply -f hasteward-job.yaml -l app.kubernetes.io/component=storage
#
# Run (edit the Job env vars + args[0], then):
#   kubectl apply -f hasteward-job.yaml -l app.kubernetes.io/component=job
#
# Subcommands: triage, repair, backup, restore, export, prune, get
#
# Environment variables:
#   HASTEWARD_ENGINE=<cnpg|galera>          (required)
#   HASTEWARD_CLUSTER=<name>                (required)
#   HASTEWARD_NAMESPACE=<ns>                (required)
#   HASTEWARD_BACKUPS_PATH=/backups         (required for repair/backup/restore)
#   RESTIC_PASSWORD=<password>              (required for backup/restore/repair)
#   HASTEWARD_INSTANCE=<N>                  (optional, repair only)
#   HASTEWARD_FORCE=true                    (optional, targeted repair only)
#   HASTEWARD_NO_ESCROW=true                (optional, skip escrow)
#   HASTEWARD_BACKUP_METHOD=<dump|native>   (optional, default: dump)

# --- RBAC (apply once) ---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: hasteward
  namespace: fairy-bottle
  labels:
    app.kubernetes.io/name: hasteward
    app.kubernetes.io/component: rbac
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: hasteward
  labels:
    app.kubernetes.io/name: hasteward
    app.kubernetes.io/component: rbac
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: hasteward
subjects:
  - kind: ServiceAccount
    name: hasteward
    namespace: fairy-bottle
---
# --- Backups PV (apply once) ---
apiVersion: v1
kind: PersistentVolume
metadata:
  name: fairy-bottle-hasteward-backups-pv
  labels:
    app.kubernetes.io/name: hasteward
    app.kubernetes.io/component: storage
spec:
  capacity:
    storage: 1Gi
  accessModes:
    - ReadWriteMany
  persistentVolumeReclaimPolicy: Retain
  claimRef:
    apiVersion: v1
    kind: PersistentVolumeClaim
    name: hasteward-backups
    namespace: fairy-bottle
  csi:
    driver: gorons-bracelet.cephfs.csi.ceph.com
    nodeStageSecretRef:
      name: csi-cephfs-node
      namespace: gorons-bracelet
    volumeAttributes:
      clusterID: 0985467c-d8f3-4483-b27f-f0a512397ec2
      fsName: Seed_Bank
      staticVolume: "true"
      rootPath: /dungeon/hdd/hasteward/backups
    volumeHandle: fairy-bottle-hasteward-backups
---
# --- Backups PVC (apply once) ---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: hasteward-backups
  namespace: fairy-bottle
  labels:
    app.kubernetes.io/name: hasteward
    app.kubernetes.io/component: storage
spec:
  accessModes:
    - ReadWriteMany
  resources:
    requests:
      storage: 1Gi
  volumeName: fairy-bottle-hasteward-backups-pv
  storageClassName: ""
---
# --- Job (edit env vars + args[0], apply per-run) ---
apiVersion: batch/v1
kind: Job
metadata:
  name: hasteward-run
  namespace: fairy-bottle
  labels:
    app.kubernetes.io/name: hasteward
    app.kubernetes.io/component: job
spec:
  ttlSecondsAfterFinished: 3600
  backoffLimit: 0
  template:
    metadata:
      labels:
        app.kubernetes.io/name: hasteward
    spec:
      serviceAccountName: hasteward
      restartPolicy: Never
      containers:
        - name: hasteward
          image: docker.io/prplanit/hasteward:latest
          # --- EDIT SUBCOMMAND: triage, repair, backup, restore ---
          args: ["repair"]
          # --- EDIT THESE ENV VARS PER RUN ---
          env:
            - name: HASTEWARD_ENGINE
              value: galera
            - name: HASTEWARD_CLUSTER
              value: kimai-mariadb
            - name: HASTEWARD_NAMESPACE
              value: temple-of-time
            - name: HASTEWARD_BACKUPS_PATH
              value: /backups
          volumeMounts:
            - name: backups
              mountPath: /backups
      volumes:
        - name: backups
          persistentVolumeClaim:
            claimName: hasteward-backups
