---
# kubelet-image-gc.yaml
# Configures kubelet image garbage collection on all k8s nodes
# Defaults (85%/80%) are too high â€” old images from renovate updates pile up
# Run via Semaphore or: ansible-playbook -i inventory k8s/tuning/kubelet-image-gc.yaml

- name: Configure kubelet image garbage collection
  hosts: k8s_worker:k8s_control_plane
  serial: 1
  become: true

  vars:
    image_gc_high_threshold: 60
    image_gc_low_threshold: 50
    image_maximum_gc_age: "168h"

  tasks:
    - name: Check current imageGCHighThresholdPercent
      shell: grep -E "^imageGCHighThresholdPercent:" /var/lib/kubelet/config.yaml || echo "not set"
      register: current_gc_high
      changed_when: false

    - name: Check current imageGCLowThresholdPercent
      shell: grep -E "^imageGCLowThresholdPercent:" /var/lib/kubelet/config.yaml || echo "not set"
      register: current_gc_low
      changed_when: false

    - name: Check current imageMaximumGCAge
      shell: grep -E "^imageMaximumGCAge:" /var/lib/kubelet/config.yaml || echo "not set"
      register: current_gc_age
      changed_when: false

    - name: Set imageGCHighThresholdPercent
      lineinfile:
        path: /var/lib/kubelet/config.yaml
        regexp: '^imageGCHighThresholdPercent:'
        line: 'imageGCHighThresholdPercent: {{ image_gc_high_threshold }}'
        insertafter: '^kind: KubeletConfiguration'
      register: gc_high_result
      when: "('imageGCHighThresholdPercent: ' ~ image_gc_high_threshold) not in current_gc_high.stdout"

    - name: Set imageGCLowThresholdPercent
      lineinfile:
        path: /var/lib/kubelet/config.yaml
        regexp: '^imageGCLowThresholdPercent:'
        line: 'imageGCLowThresholdPercent: {{ image_gc_low_threshold }}'
        insertafter: '^imageGCHighThresholdPercent:'
      register: gc_low_result
      when: "('imageGCLowThresholdPercent: ' ~ image_gc_low_threshold) not in current_gc_low.stdout"

    - name: Set imageMaximumGCAge
      lineinfile:
        path: /var/lib/kubelet/config.yaml
        regexp: '^imageMaximumGCAge:'
        line: 'imageMaximumGCAge: {{ image_maximum_gc_age }}'
        insertafter: '^imageMinimumGCAge:'
      register: gc_age_result
      when: "('imageMaximumGCAge: ' ~ image_maximum_gc_age) not in current_gc_age.stdout"

    - name: Restart kubelet
      systemd:
        name: kubelet
        state: restarted
      when: gc_high_result.changed or gc_low_result.changed or gc_age_result.changed

    - name: Wait for kubelet to restart
      pause:
        seconds: 30
      when: gc_high_result.changed or gc_low_result.changed or gc_age_result.changed

    - name: Verify kubelet is running
      systemd:
        name: kubelet
      register: kubelet_status
      until: kubelet_status.status.ActiveState == "active"
      retries: 6
      delay: 10
      when: gc_high_result.changed or gc_low_result.changed or gc_age_result.changed
